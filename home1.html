
<!DOCTYPE html>
<html class="light" lang="bn">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Labour Manager Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries,typography"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    
    <!-- Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>

    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#ec5b13",
                        "background-light": "#f8f6f6",
                        "background-dark": "#0f172a",
                        "card-dark": "#1e293b",
                    },
                    fontFamily: {
                        display: ['Public Sans', 'sans-serif'],
                        sans: ['Poppins', 'sans-serif'],
                    },
                },
            },
        };
    </script>
    <style>
        body {
            font-family: 'Public Sans', 'Poppins', sans-serif;
            min-height: max(884px, 100dvh);
            overflow-x: hidden; /* Prevent horizontal scroll during swipe */
        }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        .active-tab { color: #ec5b13; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Full Screen Overlays */
        .full-screen-overlay { 
            display: none; 
            position: fixed;
            inset: 0;
            z-index: 60; /* Higher than header (z-50) */
            background-color: inherit;
            overflow-y: auto;
        }
        .full-screen-overlay.active { display: flex; flex-direction: column; }

        /* Dialog Styles */
        .dialog-overlay {
            position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5);
            z-index: 100; opacity: 0; transition: opacity 0.3s ease-in-out;
            pointer-events: none;
        }
        .dialog-overlay.show { opacity: 1; pointer-events: auto; }
        .dialog-content {
            position: fixed; bottom: 0; left: 0; right: 0;
            background-color: white;
            border-top-left-radius: 1rem;
            border-top-right-radius: 1rem;
            padding: 1.5rem; z-index: 101;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: visible;
        }
        .dark .dialog-content { background-color: #1e293b; color: white; }
        .dialog-overlay.show .dialog-content { transform: translateY(0); }

        /* --- FIX: Center Floating Dialog Styles --- */
        #clear-selection-dialog .dialog-content {
            bottom: auto;
            top: 50%;
            left: 50%;
            right: auto;
            width: 90%;
            max-width: 320px;
            border-radius: 1.5rem;
            transform: translate(-50%, -50%) !important;
            padding: 1.5rem;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }
        
        /* Animation for Center Dialog */
        #clear-selection-dialog.show .dialog-content {
            animation: popInCenter 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        
        @keyframes popInCenter {
            from { opacity: 0; transform: translate(-50%, -45%) scale(0.95); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        /* ------------------------------------------ */

        /* Toast Message */
        #toast-box {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 30px;
            font-size: 14px;
        }
        #toast-box.show {
            visibility: visible;
            -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }
        @-webkit-keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @-webkit-keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #ec5b13; }
        .toggle-checkbox:checked + .toggle-label { background-color: #ec5b13; }
        
        .blob-shape { border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%; }
        .field-container {
            transition: all 0.5s ease-in-out; overflow: hidden;
            max-height: 200px; opacity: 1;
        }
        .field-container.hidden-field {
            max-height: 0; opacity: 0; margin: 0; padding: 0;
        }
        
        /* Custom Dropdown Style */
        .custom-dropdown-list {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            background-color: white;
            position: absolute;
            width: 100%;
            z-index: 50;
            display: none;
        }
        .dark .custom-dropdown-list {
            background-color: #1e293b;
            border-color: #334155;
        }
        .custom-dropdown-list.show { display: block; }
        .dropdown-item {
            padding: 10px 12px;
            cursor: pointer;
            font-size: 14px;
            border-bottom: 1px solid #f1f5f9;
        }
        .dark .dropdown-item { border-bottom: 1px solid #334155; }
        .dropdown-item:hover { background-color: #f8fafc; }
        .dark .dropdown-item:hover { background-color: #334155; }
        
        /* Specific styles for Workplace Screen Animation */
        #select-workplace-screen {
            display: flex;
            transform: translateX(-100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            z-index: 110; 
            position: fixed;
            inset: 0;
        }
        #select-workplace-screen.active {
            transform: translateX(0);
            pointer-events: auto;
        }
        
        /* Progress Bar Styles */
        #progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 0;
            height: 3px;
            background-color: #ec5b13;
            z-index: 9999;
            transition: width 3s ease-out;
            display: none;
        }

        /* Withdrawal Amount Chips */
        .amount-chip {
            transition: all 0.2s;
        }
        .amount-chip:active {
            transform: scale(0.95);
        }
        
        /* Tab Active State in History */
        .history-tab.active {
            background-color: #ec5b13;
            color: white;
            border-color: #ec5b13;
        }

        /* Selection Mode Styles */
        .history-item-selected {
            border-left: 4px solid #ec5b13 !important;
            background-color: rgba(236, 91, 19, 0.05);
        }
        .dark .history-item-selected {
            background-color: rgba(236, 91, 19, 0.15);
        }
        
        /* Floating Dialog Animation */
        .fade-in-up {
            animation: fadeInUp 0.3s ease-out forwards;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translate(-50%, 20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }

        /* Notification Swipe Styles */
        .notification-item {
            transition: transform 0.2s ease-out, opacity 0.2s ease-out, height 0.2s ease-out;
            touch-action: pan-y; /* Allow vertical scroll, handle horizontal in JS */
            position: relative;
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-white min-h-screen flex flex-col selection:bg-primary selection:text-white transition-colors duration-300">
<!-- Progress Bar -->
<div id="progress-bar"></div>

<!-- Authentication Screen -->
<div id="auth-screen" class="min-h-screen flex flex-col">
    <div class="max-w-md mx-auto min-h-screen flex flex-col relative pb-6 w-full">
        <header class="pt-12 px-6 pb-6 flex items-start justify-between relative z-10">
            <div class="w-1/2 pt-4">
                <h1 class="text-3xl font-bold leading-tight tracking-tight text-slate-800 dark:text-white" id="header-title">
                    Here's<br/>your first<br/>step with<br/>us!
                </h1>
            </div>
            <div class="w-1/2 relative flex justify-end">
                <div class="absolute inset-0 bg-white dark:bg-slate-700 opacity-90 blob-shape transform scale-110 translate-x-4 -translate-y-2 z-0"></div>
                <img alt="Login Image" class="relative z-10 w-36 h-36 object-cover object-top mask-image-blob rounded-full mix-blend-multiply dark:mix-blend-normal rounded-2xl" src="https://lh3.googleusercontent.com/aida-public/AB6AXuAQQLh4qENnP9njFZ-wmdho6mZx0R4EyAbfpp0dBkD8EoOepSeA5Ad-sVjVto9g61IRUkJyvBmp006c0RtMcZCYVvoW4GCPVuqj_-hdkW27VtmvSZCLYfAgRodEUUezM5LpIVGzVUw1KlIlUdOgheAwLoWJmUB5ErKL4EREYPITCckBD95i431RdpNB9Rk-vtzYZfHQTze6DMOA5mS46afIkUbL1NWOJF3ov4Hun1dwLQXEAbBy78FsLDQfMvig5sgCRV5hrbfL1R45" style="mask-image: radial-gradient(circle, black 60%, transparent 100%);"/>
            </div>
        </header>

        <main class="flex-grow px-4 relative z-10">
            <div class="bg-white dark:bg-card-dark rounded-3xl shadow-xl px-6 py-8 w-full">
                <form id="authForm" class="space-y-6">
                    <div id="register-fields" class="field-container space-y-6">
                        <div class="relative group">
                            <label class="block text-xs font-medium text-primary uppercase tracking-wider mb-1" for="name">Name</label>
                            <input class="block w-full border-0 border-b border-gray-300 dark:border-gray-600 bg-transparent py-2 px-0 text-gray-900 dark:text-white placeholder-gray-400 focus:border-primary focus:ring-0 sm:text-lg font-medium transition-colors" id="name" type="text" placeholder="Enter your name" />
                        </div>
                        <div class="relative group">
                            <label class="block text-xs font-medium text-primary uppercase tracking-wider mb-1" for="mobile">Mobile</label>
                            <input class="block w-full border-0 border-b border-gray-300 dark:border-gray-600 bg-transparent py-2 px-0 text-gray-900 dark:text-white placeholder-gray-400 focus:border-primary focus:ring-0 sm:text-lg font-medium transition-colors" id="mobile" type="tel" placeholder="Enter your mobile number" />
                        </div>
                    </div>
                    <div class="relative group">
                        <label class="block text-xs font-medium text-primary uppercase tracking-wider mb-1" for="email">Email</label>
                        <input class="block w-full border-0 border-b border-gray-300 dark:border-gray-600 bg-transparent py-2 px-0 text-gray-900 dark:text-white placeholder-gray-400 focus:border-primary focus:ring-0 sm:text-lg font-medium transition-colors" id="email" type="email" placeholder="Enter your email" />
                    </div>
                    <div class="relative group">
                        <label class="block text-xs font-medium text-primary uppercase tracking-wider mb-1" for="password">Password</label>
                        <input class="block w-full border-0 border-b border-gray-300 dark:border-gray-600 bg-transparent py-2 px-0 text-gray-900 dark:text-white placeholder-gray-400 focus:border-primary focus:ring-0 sm:text-lg font-medium tracking-widest transition-colors" id="password" type="password" placeholder="Create a password" />
                    </div>
                    <div class="pt-6 pb-2">
                        <button id="authButton" class="w-full flex justify-center py-4 px-4 border border-transparent rounded-full shadow-sm text-lg font-bold text-white bg-primary hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-all transform active:scale-95 shadow-lg shadow-orange-500/30" type="button">
                            Register
                        </button>
                    </div>
                     <p id="auth-error" class="text-red-500 text-xs text-center pt-2"></p>
                    <div class="text-center mt-4">
                        <p class="text-sm text-gray-400 cursor-pointer hover:text-slate-600 dark:hover:text-slate-300 transition-colors" id="toggleText">
                            Already have an account? <span class="text-primary font-bold">Login</span>
                        </p>
                    </div>
                </form>
            </div>
        </main>
    </div>
</div>

<!-- Main App Container -->
<div id="app-screen" class="hidden h-full flex-col">
    <!-- Top Header (Will be hidden on Profile Tab) -->
    <header id="main-header" class="sticky top-0 z-50 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-md border-b border-slate-200 dark:border-slate-800 px-4 py-3 flex items-center justify-between transition-all duration-300">
        <div class="flex items-center gap-3">
            <div class="relative">
                <img id="header-profile-img" alt="User Profile" class="w-10 h-10 rounded-full object-cover border-2 border-primary/20" src="https://lh3.googleusercontent.com/aida-public/AB6AXuAUKvT3-9wsXtOXuexCaR4tiCdUDIasbk5S86_Kb7UTVUKQynrMvwS7CQwGtG-y4bKuEHG0AcZiK38pT0qy4NO4Qk0XTxQ8J-MzZiy5bbfdg38hbjAmggQ2rXdgDFYj47Xa2tfniztNBvpHFcgdDFtNSaQGblhHzy-DsyL5JhFyo-32ust-621SzcqfyL-SENSjuDpfd3lt5q16qZDJwXd8EGbkju_tRw8mNp_IZ9Dja8SuYuW_9QP6u39_ivI5O1WvVJzGQU8szl7C"/>
                <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white dark:border-background-dark rounded-full"></div>
            </div>
            <div>
                <p class="text-xs text-slate-500 dark:text-slate-400 font-medium">Good morning,</p>
                <h1 id="user-name" class="text-base font-bold leading-tight text-slate-900 dark:text-white">User</h1>
            </div>
        </div>
        <button id="notification-bell-btn" class="relative p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
            <span class="material-symbols-outlined text-slate-600 dark:text-slate-300">notifications</span>
            <span class="absolute top-2 right-2 w-2 h-2 bg-primary rounded-full ring-2 ring-background-light dark:ring-background-dark"></span>
        </button>
    </header>

    <!-- Main Content -->
    <main class="flex-1 px-4 py-4 overflow-y-auto pb-24 relative">
        <!-- Labour Tab -->
        <div id="labour-tab" class="tab-content active">
            <!-- Adsterra Banner Ad (Labour Tab) -->
            <div class="ad-container w-full flex justify-center mb-4 overflow-hidden">
                <script type="text/javascript">
                    atOptions = {
                        'key' : '78deddac9721d5b7a4df97bcfc32679d',
                        'format' : 'iframe',
                        'height' : 90,
                        'width' : 728,
                        'params' : {}
                    };
                </script>
                <script type="text/javascript" src="https://www.highperformanceformat.com/78deddac9721d5b7a4df97bcfc32679d/invoke.js"></script>
            </div>

             <div class="mb-6">
                <div class="relative group">
                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-primary transition-colors">search</span>
                    <input id="labour-search-input" class="w-full bg-white dark:bg-card-dark border border-slate-200 dark:border-slate-700 rounded-xl py-3 pl-10 pr-4 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-slate-400 text-sm dark:text-white" placeholder="Search by name or mobile" type="text"/>
                </div>
            </div>
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-bold tracking-tight text-slate-900 dark:text-white">All Labour</h2>
                <button class="text-primary text-xs font-semibold hover:underline">View All</button>
            </div>
            <div id="labour-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                 <p class="col-span-full text-center text-slate-500">Loading data...</p>
            </div>
        </div>

        <!-- Conductor Tab -->
        <div id="conductor-tab" class="tab-content">
            <!-- Adsterra Banner Ad (Conductor Tab) -->
            <div class="ad-container w-full flex justify-center mb-4 overflow-hidden">
                <script type="text/javascript">
                    atOptions = {
                        'key' : '78deddac9721d5b7a4df97bcfc32679d',
                        'format' : 'iframe',
                        'height' : 90,
                        'width' : 728,
                        'params' : {}
                    };
                </script>
                <script type="text/javascript" src="https://www.highperformanceformat.com/78deddac9721d5b7a4df97bcfc32679d/invoke.js"></script>
            </div>

            <div class="mb-6">
                <div class="relative group">
                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-primary transition-colors">search</span>
                    <input id="conductor-search-input" class="w-full bg-white dark:bg-card-dark border border-slate-200 dark:border-slate-700 rounded-xl py-3 pl-10 pr-4 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-slate-400 text-sm dark:text-white" placeholder="Search by name or mobile" type="text"/>
                </div>
            </div>

            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-bold tracking-tight text-slate-900 dark:text-white">All Conductors</h2>
                <button class="text-primary text-xs font-semibold hover:underline">View All</button>
            </div>
            <div id="conductor-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                 <p class="col-span-full text-center text-slate-500">Loading data...</p>
            </div>
        </div>

        <!-- Room Tab -->
        <div id="room-tab" class="tab-content">
            <!-- Adsterra Banner Ad (Room Tab) -->
            <div class="ad-container w-full flex justify-center mb-4 overflow-hidden">
                <script type="text/javascript">
                    atOptions = {
                        'key' : '78deddac9721d5b7a4df97bcfc32679d',
                        'format' : 'iframe',
                        'height' : 90,
                        'width' : 728,
                        'params' : {}
                    };
                </script>
                <script type="text/javascript" src="https://www.highperformanceformat.com/78deddac9721d5b7a4df97bcfc32679d/invoke.js"></script>
            </div>

             <div class="mb-6">
                <div class="relative group">
                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-primary transition-colors">search</span>
                    <input id="room-search-input" class="w-full bg-white dark:bg-card-dark border border-slate-200 dark:border-slate-700 rounded-xl py-3 pl-10 pr-4 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-slate-400 text-sm dark:text-white" placeholder="Search by name or mobile" type="text"/>
                </div>
            </div>

             <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-bold tracking-tight text-slate-900 dark:text-white">All Rooms</h2>
                <button class="text-primary text-xs font-semibold hover:underline">View All</button>
            </div>
            <div id="room-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                 <p class="col-span-full text-center text-slate-500">Loading data...</p>
            </div>
        </div>
        
        <!-- Profile Tab -->
        <div id="profile-tab" class="tab-content pt-2">
            <!-- Adsterra Banner Ad (Profile Tab) -->
            <div class="ad-container w-full flex justify-center mb-4 overflow-hidden">
                <script type="text/javascript">
                    atOptions = {
                        'key' : '78deddac9721d5b7a4df97bcfc32679d',
                        'format' : 'iframe',
                        'height' : 90,
                        'width' : 728,
                        'params' : {}
                    };
                </script>
                <script type="text/javascript" src="https://www.highperformanceformat.com/78deddac9721d5b7a4df97bcfc32679d/invoke.js"></script>
            </div>

            <!-- Wallet Card (MODIFIED) -->
            <div class="w-full bg-gradient-to-r from-orange-500 to-red-600 rounded-2xl p-6 text-white shadow-lg mb-6 relative overflow-hidden">
                <div class="absolute -top-10 -right-10 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                <div class="absolute -bottom-10 -left-10 w-32 h-32 bg-black/10 rounded-full blur-2xl"></div>
                
                <!-- Profile Section inside Card -->
                <div class="flex items-center justify-between mb-6 border-b border-white/20 pb-4">
                    <div class="flex items-center gap-3">
                         <img id="wallet-card-img" alt="Profile" class="w-12 h-12 rounded-full object-cover border-2 border-white/50" src="https://lh3.googleusercontent.com/aida-public/AB6AXuAUKvT3-9wsXtOXuexCaR4tiCdUDIasbk5S86_Kb7UTVUKQynrMvwS7CQwGtG-y4bKuEHG0AcZiK38pT0qy4NO4Qk0XTxQ8J-MzZiy5bbfdg38hbjAmggQ2rXdgDFYj47Xa2tfniztNBvpHFcgdDFtNSaQGblhHzy-DsyL5JhFyo-32ust-621SzcqfyL-SENSjuDpfd3lt5q16qZDJwXd8EGbkju_tRw8mNp_IZ9Dja8SuYuW_9QP6u39_ivI5O1WvVJzGQU8szl7C">
                         <div>
                             <h3 id="wallet-card-name" class="font-bold text-lg">User Name</h3>
                             <p class="text-[10px] opacity-80 uppercase tracking-wide">Manager Account</p>
                         </div>
                    </div>
                    <button onclick="openUpdateProfileScreen()" class="p-2 bg-white/20 rounded-full hover:bg-white/30 transition-colors backdrop-blur-sm shadow-sm">
                        <span class="material-symbols-outlined text-sm">edit</span>
                    </button>
                </div>

                <!-- Withdraw Button -->
                <button id="open-withdraw-btn" class="absolute bottom-6 right-6 bg-white/20 hover:bg-white/30 text-white text-xs font-bold py-1 px-3 rounded-full transition-colors backdrop-blur-sm flex items-center gap-1">
                    Withdraw <span class="material-symbols-outlined text-sm">arrow_forward</span>
                </button>

                <div class="flex items-center gap-3 mb-2">
                    <span class="p-2 bg-white/20 rounded-full">
                        <span class="material-symbols-outlined text-white text-xl">account_balance_wallet</span>
                    </span>
                    <span class="text-sm font-medium opacity-90">Total Balance</span>
                </div>
                <h2 class="text-3xl font-bold tracking-tight flex items-center">
                    ₹ <span id="wallet-balance">0</span>
                </h2>
                <p class="text-xs mt-2 opacity-80">Indian Currency</p>
            </div>

            <!-- Menu List -->
            <div class="space-y-3">
                <div onclick="document.getElementById('labour-tab-nav').click()" class="cursor-pointer flex items-center justify-between p-4 bg-white dark:bg-card-dark rounded-xl shadow border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                    <div class="flex items-center gap-4">
                        <span class="material-symbols-outlined text-primary">home</span>
                        <span class="font-semibold text-slate-800 dark:text-white">Home</span>
                    </div>
                    <span class="material-symbols-outlined text-slate-400 text-sm">arrow_forward_ios</span>
                </div>

                <div id="refer-menu-btn" class="cursor-pointer flex items-center justify-between p-4 bg-white dark:bg-card-dark rounded-xl shadow border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                    <div class="flex items-center gap-4">
                        <span class="material-symbols-outlined text-primary">share</span>
                        <span class="font-semibold text-slate-800 dark:text-white">Refer & Earn</span>
                    </div>
                    <span class="material-symbols-outlined text-slate-400 text-sm">arrow_forward_ios</span>
                </div>

                <div class="flex items-center justify-between p-4 bg-white dark:bg-card-dark rounded-xl shadow border border-slate-200 dark:border-slate-700">
                    <div class="flex items-center gap-4">
                        <span class="material-symbols-outlined text-primary">dark_mode</span>
                        <span class="font-semibold text-slate-800 dark:text-white">Dark Mode</span>
                    </div>
                    <!-- Switch -->
                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" name="toggle" id="theme-toggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300"/>
                        <label for="theme-toggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-300 cursor-pointer"></label>
                    </div>
                </div>

                <div id="terms-menu-btn" class="cursor-pointer flex items-center gap-4 p-4 bg-white dark:bg-card-dark rounded-xl shadow border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                    <span class="material-symbols-outlined text-primary">gavel</span>
                    <span class="font-semibold text-slate-800 dark:text-white">Terms Condition</span>
                </div>
                
                <div id="privacy-menu-btn" class="cursor-pointer flex items-center gap-4 p-4 bg-white dark:bg-card-dark rounded-xl shadow border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                    <span class="material-symbols-outlined text-primary">privacy_tip</span>
                    <span class="font-semibold text-slate-800 dark:text-white">Privacy Policy</span>
                </div>
            </div>

            <!-- Logout Button -->
            <button id="logout-btn" class="mt-6 w-full bg-primary/10 text-primary py-3 rounded-lg font-semibold hover:bg-primary/20 transition-colors border border-primary/20">Logout</button>
        </div>

        <!-- NEW: Update Profile Screen -->
        <div id="update-profile-screen" class="full-screen-overlay bg-background-light dark:bg-background-dark p-4">
            <div class="flex items-center gap-3 mb-6">
                <button onclick="document.getElementById('update-profile-screen').classList.remove('active')" class="p-2 bg-white dark:bg-card-dark rounded-full shadow hover:scale-105 transition-transform">
                    <span class="material-symbols-outlined text-slate-800 dark:text-white">arrow_back</span>
                </button>
                <h2 class="text-xl font-bold text-slate-900 dark:text-white">Update Profile</h2>
            </div>
            
            <div class="bg-white dark:bg-card-dark rounded-2xl shadow border border-slate-200 dark:border-slate-700 p-6">
                <div class="flex flex-col items-center mb-6">
                    <img id="update-profile-img-preview" src="" class="w-24 h-24 rounded-full object-cover border-4 border-slate-100 dark:border-slate-800 mb-3">
                    <p class="text-xs text-slate-500">Profile Picture URL is synced with database.</p>
                </div>
                
                <form id="update-profile-form" class="space-y-4">
                     <!-- Image URL Input -->
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 mb-1">Profile Image URL</label>
                        <input type="text" id="update-profile-url" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-xl p-3 outline-none text-sm text-slate-900 dark:text-white transition-colors focus:ring-2 focus:ring-primary/20" placeholder="Paste image link">
                    </div>

                    <div>
                        <label class="block text-xs font-semibold text-slate-500 mb-1">Full Name</label>
                        <input type="text" id="update-name" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-xl p-3 outline-none text-sm text-slate-900 dark:text-white transition-colors focus:ring-2 focus:ring-primary/20">
                    </div>
                    
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 mb-1">Mobile Number</label>
                        <input type="tel" id="update-mobile" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-xl p-3 outline-none text-sm text-slate-900 dark:text-white transition-colors focus:ring-2 focus:ring-primary/20">
                    </div>

                    <div>
                        <label class="block text-xs font-semibold text-slate-500 mb-1">Email Address</label>
                        <input type="email" id="update-email" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-xl p-3 outline-none text-sm text-slate-900 dark:text-white transition-colors focus:ring-2 focus:ring-primary/20" readonly> <!-- Email usually shouldn't change easily without re-auth, making readonly for safety but shows data -->
                    </div>

                    <div>
                        <label class="block text-xs font-semibold text-slate-500 mb-1">Password</label>
                        <div class="relative">
                            <input type="text" id="update-password" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-xl p-3 outline-none text-sm text-slate-900 dark:text-white transition-colors focus:ring-2 focus:ring-primary/20">
                             <span class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">lock</span>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-semibold text-slate-500 mb-1">Wallet MPIN</label>
                        <input type="text" id="update-mpin" maxlength="4" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-xl p-3 outline-none text-sm text-slate-900 dark:text-white transition-colors focus:ring-2 focus:ring-primary/20 tracking-widest text-center font-bold">
                    </div>

                    <button type="button" id="save-profile-btn" class="w-full mt-4 bg-primary text-white py-3 rounded-xl font-bold hover:bg-opacity-90 transition-all shadow-lg shadow-orange-500/30">
                        Update Profile
                    </button>
                </form>
            </div>
        </div>

        <!-- Withdrawal Screen (NEW) -->
        <div id="withdrawal-screen" class="full-screen-overlay bg-background-light dark:bg-background-dark p-4">
            <div class="flex items-center gap-3 mb-6">
                <button id="back-withdraw-btn" class="p-2 bg-white dark:bg-card-dark rounded-full shadow hover:scale-105 transition-transform">
                    <span class="material-symbols-outlined text-slate-800 dark:text-white">arrow_back</span>
                </button>
                <h2 class="text-xl font-bold text-slate-900 dark:text-white">Withdrawal</h2>
            </div>
            
            <div class="flex flex-col items-center">
                <h3 class="text-sm font-medium text-slate-500 dark:text-slate-400">Total Balance</h3>
                <h1 class="text-3xl font-bold text-slate-900 dark:text-white mt-1">₹ <span id="withdraw-balance">0</span></h1>
            </div>

            <!-- Bank Box -->
            <div id="bank-box" class="mt-6 w-full bg-white dark:bg-card-dark p-4 rounded-2xl shadow border border-slate-200 dark:border-slate-700 flex items-center justify-between cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                <div class="flex items-center gap-3">
                    <span class="p-2 bg-primary/10 rounded-lg">
                        <span class="material-symbols-outlined text-primary">account_balance</span>
                    </span>
                    <div id="bank-info-display">
                        <p class="text-sm font-bold text-primary">Add Bank Account</p>
                        <p class="text-xs text-slate-400">To withdraw funds</p>
                    </div>
                </div>
                <span class="material-symbols-outlined text-slate-400">arrow_forward_ios</span>
            </div>

            <!-- Amount Input -->
            <div class="mt-6">
                <label class="block text-xs font-medium text-slate-500 mb-2 uppercase">Enter Amount</label>
                <div class="relative">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-900 dark:text-white font-bold text-lg">₹</span>
                    <input type="number" id="withdraw-amount-input" class="w-full bg-white dark:bg-card-dark border border-slate-200 dark:border-slate-700 rounded-xl py-3 pl-8 pr-4 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all font-bold text-lg text-slate-900 dark:text-white" placeholder="0"/>
                </div>
            </div>

            <!-- Amount Chips -->
            <div class="grid grid-cols-4 gap-3 mt-4">
                <button class="amount-chip py-2 bg-white dark:bg-card-dark border border-slate-200 dark:border-slate-700 rounded-lg text-xs font-semibold text-slate-700 dark:text-slate-300 hover:border-primary hover:text-primary transition-all">1</button>
                <button class="amount-chip py-2 bg-white dark:bg-card-dark border border-slate-200 dark:border-slate-700 rounded-lg text-xs font-semibold text-slate-700 dark:text-slate-300 hover:border-primary hover:text-primary transition-all">5</button>
                <button class="amount-chip py-2 bg-white dark:bg-card-dark border border-slate-200 dark:border-slate-700 rounded-lg text-xs font-semibold text-slate-700 dark:text-slate-300 hover:border-primary hover:text-primary transition-all">10</button>
                <button class="amount-chip py-2 bg-white dark:bg-card-dark border border-slate-200 dark:border-slate-700 rounded-lg text-xs font-semibold text-slate-700 dark:text-slate-300 hover:border-primary hover:text-primary transition-all">20</button>
                <button class="amount-chip py-2 bg-white dark:bg-card-dark border border-slate-200 dark:border-slate-700 rounded-lg text-xs font-semibold text-slate-700 dark:text-slate-300 hover:border-primary hover:text-primary transition-all">50</button>
                <button class="amount-chip py-2 bg-white dark:bg-card-dark border border-slate-200 dark:border-slate-700 rounded-lg text-xs font-semibold text-slate-700 dark:text-slate-300 hover:border-primary hover:text-primary transition-all">100</button>
                <button class="amount-chip py-2 bg-white dark:bg-card-dark border border-slate-200 dark:border-slate-700 rounded-lg text-xs font-semibold text-slate-700 dark:text-slate-300 hover:border-primary hover:text-primary transition-all">200</button>
                <button class="amount-chip py-2 bg-white dark:bg-card-dark border border-slate-200 dark:border-slate-700 rounded-lg text-xs font-semibold text-slate-700 dark:text-slate-300 hover:border-primary hover:text-primary transition-all">300</button>
            </div>

            <!-- Withdraw Button -->
            <button id="final-withdraw-btn" class="mt-8 w-full bg-primary text-white py-3 rounded-xl font-bold shadow-lg shadow-orange-500/30 hover:opacity-90 transition-opacity">Withdraw</button>
            
            <!-- History Box -->
             <div id="open-withdraw-history" class="mt-6 w-full bg-white dark:bg-card-dark p-3 rounded-xl shadow border border-slate-200 dark:border-slate-700 flex items-center justify-between cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                <div class="flex items-center gap-2">
                     <span class="material-symbols-outlined text-slate-500">history</span>
                     <span class="text-sm font-semibold text-slate-700 dark:text-slate-300">History</span>
                </div>
                 <span class="material-symbols-outlined text-slate-400 text-sm">arrow_forward_ios</span>
             </div>
        </div>
        
        <!-- Withdrawal History Screen (NEW) -->
         <div id="withdrawal-history-screen" class="full-screen-overlay bg-background-light dark:bg-background-dark p-4">
             <div class="flex items-center gap-3 mb-6">
                <button id="back-withdraw-history-btn" class="p-2 bg-white dark:bg-card-dark rounded-full shadow hover:scale-105 transition-transform">
                    <span class="material-symbols-outlined text-slate-800 dark:text-white">arrow_back</span>
                </button>
                <h2 class="text-xl font-bold text-slate-900 dark:text-white">Withdrawal History</h2>
            </div>
            
            <!-- Filters -->
            <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
                <button class="history-tab active px-4 py-2 rounded-full border border-slate-200 dark:border-slate-700 bg-white dark:bg-card-dark text-xs font-bold transition-colors whitespace-nowrap" data-filter="7">7 Days</button>
                <button class="history-tab px-4 py-2 rounded-full border border-slate-200 dark:border-slate-700 bg-white dark:bg-card-dark text-xs font-bold text-slate-500 dark:text-slate-400 transition-colors whitespace-nowrap" data-filter="30">1 Month</button>
                <button class="history-tab px-4 py-2 rounded-full border border-slate-200 dark:border-slate-700 bg-white dark:bg-card-dark text-xs font-bold text-slate-500 dark:text-slate-400 transition-colors whitespace-nowrap" data-filter="365">1 Year</button>
            </div>
            
            <div id="withdrawal-list" class="space-y-3 overflow-y-auto pb-20">
                <p class="text-center text-slate-400 text-sm py-10">Loading...</p>
            </div>
         </div>

        <!-- Add Bank Dialog (NEW) -->
        <div id="add-bank-dialog" class="dialog-overlay">
            <div class="dialog-content">
                <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white">Add Bank Account</h3>
                <div class="space-y-3">
                     <select id="bank-name-select" class="w-full bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-3 outline-none text-sm text-slate-900 dark:text-white">
                         <option value="" disabled selected>Select Bank</option>
                         <!-- JS will populate banks -->
                     </select>
                     <input type="number" id="bank-acc-no" placeholder="Account Number" class="w-full bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-3 outline-none text-sm text-slate-900 dark:text-white">
                     <input type="text" id="bank-ifsc" placeholder="IFSC Code" class="w-full bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-3 outline-none text-sm text-slate-900 dark:text-white uppercase">
                     <input type="text" id="bank-holder" placeholder="Account Holder Name" class="w-full bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-3 outline-none text-sm text-slate-900 dark:text-white">
                </div>
                <div class="flex gap-2 mt-6">
                    <button onclick="document.getElementById('add-bank-dialog').classList.remove('show')" class="w-full bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">Cancel</button>
                    <button id="save-bank-btn" class="w-full bg-primary text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">Save</button>
                </div>
            </div>
        </div>

        <!-- Refer Screen (Overlay) - MODIFIED -->
        <div id="refer-screen" class="full-screen-overlay bg-background-light dark:bg-background-dark p-4">
             <div class="flex-shrink-0">
                <button id="back-refer-btn" class="absolute top-4 left-4 p-2 bg-white dark:bg-card-dark rounded-full shadow z-10 hover:scale-105 transition-transform">
                    <span class="material-symbols-outlined text-slate-800 dark:text-white">arrow_back</span>
                </button>
            </div>
            <div class="flex-grow overflow-y-auto pt-16 pb-6">
                <div class="flex flex-col items-center">
                    <!-- New Canvas Image -->
                    <div class="w-full max-w-sm h-auto bg-white dark:bg-card-dark rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 flex items-center justify-center mb-6 overflow-hidden relative p-4">
                         <img src="https://img.freepik.com/free-vector/network-marketing-illustration_1284-48995.jpg?w=740" class="w-full h-full object-contain" alt="Referral Chain System">
                    </div>

                    <!-- New Info Boxes -->
                    <div class="w-full grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-white dark:bg-card-dark p-4 rounded-2xl shadow border border-slate-200 dark:border-slate-700 text-center">
                            <p class="text-sm font-semibold text-slate-500 dark:text-slate-400 mb-1">Total Referrals</p>
                            <div class="flex items-center justify-center gap-2">
                                <span class="material-symbols-outlined text-lg text-primary">groups</span>
                                <span id="total-referrals-count" class="text-2xl font-bold text-slate-800 dark:text-white">0</span>
                            </div>
                        </div>
                         <div class="bg-white dark:bg-card-dark p-4 rounded-2xl shadow border border-slate-200 dark:border-slate-700 text-center">
                            <p class="text-sm font-semibold text-slate-500 dark:text-slate-400 mb-1">Total Earnings</p>
                             <div class="flex items-center justify-center gap-2">
                                <span class="text-xl font-bold text-primary">₹</span>
                                <span id="total-earnings-count" class="text-2xl font-bold text-slate-800 dark:text-white">0</span>
                            </div>
                        </div>
                    </div>

                    <div class="w-full bg-white dark:bg-card-dark p-6 rounded-2xl shadow border border-slate-200 dark:border-slate-700 text-center mb-6">
                        <p class="text-sm text-slate-500 dark:text-slate-400 mb-2">Your Promo Code</p>
                        <div class="bg-slate-100 dark:bg-slate-800 py-3 px-6 rounded-lg border-dashed border-2 border-primary/50 relative">
                            <span class="text-2xl font-bold text-primary tracking-widest" id="my-promo-code">...</span>
                            <button id="copy-code-btn" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-primary">
                                <span class="material-symbols-outlined text-lg">content_copy</span>
                            </button>
                        </div>
                        <p class="text-xs text-slate-400 mt-3">Share this code with your friends.</p>
                        
                        <!-- NEW: Social Share Icons -->
                        <div class="mt-4 flex justify-center items-center gap-4">
                            <a href="#" onclick="shareReferral('whatsapp')" class="w-10 h-10 flex items-center justify-center bg-green-500 text-white rounded-full text-xl"><i class="fab fa-whatsapp"></i></a>
                            <a href="#" onclick="shareReferral('facebook')" class="w-10 h-10 flex items-center justify-center bg-blue-600 text-white rounded-full text-xl"><i class="fab fa-facebook-f"></i></a>
                            <a href="#" onclick="shareReferral('telegram')" class="w-10 h-10 flex items-center justify-center bg-sky-500 text-white rounded-full text-xl"><i class="fab fa-telegram-plane"></i></a>
                            <a href="#" onclick="shareReferral('sms')" class="w-10 h-10 flex items-center justify-center bg-slate-500 text-white rounded-full"><span class="material-symbols-outlined text-xl">sms</span></a>
                        </div>
                    </div>

                    <div class="w-full bg-white dark:bg-card-dark p-6 rounded-2xl shadow border border-slate-200 dark:border-slate-700">
                        <h3 class="font-bold text-lg mb-4 text-slate-900 dark:text-white">Have a Referral Code?</h3>
                        <div class="relative mb-4">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 material-symbols-outlined">confirmation_number</span>
                            <input id="referral-input" type="text" placeholder="Enter promo code" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-xl py-3 pl-12 pr-4 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all text-slate-900 dark:text-white font-medium uppercase placeholder:normal-case"/>
                        </div>
                        <button id="submit-refer-btn" class="w-full bg-primary text-white py-3 rounded-xl font-bold hover:opacity-90 transition-opacity shadow-lg shadow-orange-500/30">
                            Claim Reward
                        </button>
                        <p id="refer-msg" class="text-xs text-center mt-3 h-4"></p>
                    </div>
                </div>
            </div>
        </div>


        <!-- Labour View Screen
 (Updated) -->
        <div id="labour-view-screen" class="full-screen-overlay bg-background-light dark:bg-background-dark p-4">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <button id="back-labour-view-btn" class="p-2 bg-white dark:bg-card-dark rounded-full shadow hover:scale-105 transition-transform">
                        <span class="material-symbols-outlined text-slate-800 dark:text-white">arrow_back</span>
                    </button>
                    <h2 class="text-xl font-bold text-slate-900 dark:text-white">Labour Details</h2>
                </div>
                <button onclick="openClearOptionsDialog()" class="text-sm font-bold text-red-500 hover:text-red-700 transition-colors">Clear</button>
            </div>

            <!-- Top Details Card -->
            <div class="bg-white dark:bg-card-dark p-5 rounded-2xl shadow border border-slate-200 dark:border-slate-700 mb-3">
                <div class="flex justify-between items-start mb-2">
                    <h3 id="lv-name" class="text-2xl font-bold text-slate-800 dark:text-white">Labour Name</h3>
                </div>
                <div class="space-y-1 text-sm text-slate-500 dark:text-slate-400 mb-4">
                    <p class="flex items-center gap-2"><span class="material-symbols-outlined text-base">phone</span> <span id="lv-mobile">...</span></p>
                    <p class="flex items-center gap-2"><span class="material-symbols-outlined text-base">location_on</span> <span id="lv-address">...</span></p>
                </div>
                
                <!-- Stats Boxes (Updated to 3 columns) -->
                <div class="grid grid-cols-3 gap-2">
                    <div class="border-2 border-green-500/30 bg-green-50 dark:bg-green-900/10 rounded-xl p-2 text-center">
                        <p class="text-[8px] text-green-600 dark:text-green-400 font-bold uppercase tracking-wide">Total Work</p>
                        <h3 class="text-sm font-bold text-green-700 dark:text-green-300 mt-1">₹<span id="lv-total-work">0</span></h3>
                    </div>
                    <div onclick="openClearAdvanceDialog()" class="cursor-pointer border-2 border-orange-500/30 bg-orange-50 dark:bg-orange-900/10 rounded-xl p-2 text-center hover:bg-orange-100 dark:hover:bg-orange-900/20 transition-colors">
                        <p class="text-[8px] text-orange-600 dark:text-orange-400 font-bold uppercase tracking-wide">Total Advance</p>
                        <h3 class="text-sm font-bold text-orange-700 dark:text-orange-300 mt-1">₹<span id="lv-total-advance">0</span></h3>
                    </div>
                    <div class="border-2 border-blue-500/30 bg-blue-50 dark:bg-blue-900/10 rounded-xl p-2 text-center">
                        <p class="text-[8px] text-blue-600 dark:text-blue-400 font-bold uppercase tracking-wide">Subtotal</p>
                        <h3 class="text-sm font-bold text-blue-700 dark:text-blue-300 mt-1">₹<span id="lv-subtotal">0</span></h3>
                    </div>
                </div>
            </div>

            <!-- Search Bar & View All -->
            <div class="flex items-center justify-between mb-3">
                <div class="relative group flex-1 mr-3">
                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm group-focus-within:text-primary transition-colors">search</span>
                    <input id="lv-search" class="w-full bg-white dark:bg-card-dark border border-slate-200 dark:border-slate-700 rounded-lg py-2 pl-9 pr-3 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-slate-400 text-xs dark:text-white" placeholder="Search this week" type="text"/>
                </div>
                <button onclick="openViewAllScreen()" class="text-xs font-bold text-primary hover:underline whitespace-nowrap">View All</button>
            </div>

            <!-- Work List View (Weekly) -->
            <div class="flex-1 overflow-y-auto bg-white dark:bg-card-dark rounded-xl shadow-sm border border-slate-100 dark:border-slate-700">
                <div class="p-3 border-b border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 flex justify-between items-center">
                    <p class="text-xs font-semibold text-slate-500 dark:text-slate-400">Current Week (Sun - Sat)</p>
                    <button onclick="shareWeeklyReport()" class="text-green-600 hover:text-green-700 transition-colors">
                        <span class="material-symbols-outlined text-lg">share</span>
                    </button>
                </div>
                <div id="lv-work-list" class="divide-y divide-slate-100 dark:divide-slate-700">
                    <p class="text-center text-slate-400 text-sm py-10">Loading history...</p>
                </div>
            </div>
        </div>

        <!-- Conductor History Screen (New Design) -->
        <div id="conductor-history-screen" class="full-screen-overlay bg-background-light dark:bg-background-dark p-4">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <button id="back-conductor-history-btn" class="p-2 bg-white dark:bg-card-dark rounded-full shadow hover:scale-105 transition-transform">
                        <span class="material-symbols-outlined text-slate-800 dark:text-white">arrow_back</span>
                    </button>
                    <h2 class="text-xl font-bold text-slate-900 dark:text-white">Conductor Details</h2>
                </div>
                <!-- Added Clear button to match Labour Details design -->
                <button onclick="openClearConductorTotalDialog()" class="text-sm font-bold text-red-500 hover:text-red-700 transition-colors">Clear</button>
            </div>

            <!-- Top Details Card -->
            <div class="bg-white dark:bg-card-dark p-5 rounded-2xl shadow border border-slate-200 dark:border-slate-700 mb-3">
                <div class="flex justify-between items-start mb-2">
                    <h3 id="ch-name" class="text-2xl font-bold text-slate-800 dark:text-white">Conductor Name</h3>
                </div>
                <div class="space-y-1 text-sm text-slate-500 dark:text-slate-400 mb-4">
                    <p class="flex items-center gap-2"><span class="material-symbols-outlined text-base">phone</span> <span id="ch-mobile">...</span></p>
                    <p class="flex items-center gap-2"><span class="material-symbols-outlined text-base">location_on</span> <span id="ch-address">...</span></p>
                </div>
                
                <!-- Stats Boxes (Updated to 3 columns to match Labour design) -->
                <div class="grid grid-cols-3 gap-2">
                    <div class="border-2 border-green-500/30 bg-green-50 dark:bg-green-900/10 rounded-xl p-2 text-center">
                        <p class="text-[8px] text-green-600 dark:text-green-400 font-bold uppercase tracking-wide">Total Amount</p>
                        <h3 class="text-sm font-bold text-green-700 dark:text-green-300 mt-1">₹<span id="ch-total-work">0</span></h3>
                    </div>
                    <div class="border-2 border-orange-500/30 bg-orange-50 dark:bg-orange-900/10 rounded-xl p-2 text-center">
                        <p class="text-[8px] text-orange-600 dark:text-orange-400 font-bold uppercase tracking-wide">Total Advance</p>
                        <h3 class="text-sm font-bold text-orange-700 dark:text-orange-300 mt-1">₹<span id="ch-total-advance">0</span></h3>
                    </div>
                    <div class="border-2 border-blue-500/30 bg-blue-50 dark:bg-blue-900/10 rounded-xl p-2 text-center">
                        <p class="text-[8px] text-blue-600 dark:text-blue-400 font-bold uppercase tracking-wide">Subtotal</p>
                        <h3 class="text-sm font-bold text-blue-700 dark:text-blue-300 mt-1">₹<span id="ch-subtotal">0</span></h3>
                    </div>
                </div>
            </div>

            <!-- Search Bar & View All -->
            <div class="flex items-center justify-between mb-3">
                <div class="relative group flex-1 mr-3">
                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm group-focus-within:text-primary transition-colors">search</span>
                    <input id="ch-search" class="w-full bg-white dark:bg-card-dark border border-slate-200 dark:border-slate-700 rounded-lg py-2 pl-9 pr-3 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-slate-400 text-xs dark:text-white" placeholder="Search this week" type="text"/>
                </div>
                <button onclick="openConductorViewAll()" class="text-xs font-bold text-primary hover:underline whitespace-nowrap">View All</button>
            </div>

            <!-- Work List View (Weekly) -->
            <div class="flex-1 overflow-y-auto bg-white dark:bg-card-dark rounded-xl shadow-sm border border-slate-100 dark:border-slate-700">
                <div class="p-3 border-b border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 flex justify-between items-center">
                    <p class="text-xs font-semibold text-slate-500 dark:text-slate-400">Current Week (Sun - Sat)</p>
                    <button onclick="shareConductorReport()" class="text-green-600 hover:text-green-700 transition-colors">
                        <span class="material-symbols-outlined text-lg">share</span>
                    </button>
                </div>
                <div id="ch-work-list" class="divide-y divide-slate-100 dark:divide-slate-700">
                    <p class="text-center text-slate-400 text-sm py-10">Loading history...</p>
                </div>
            </div>
        </div>

        <!-- Room View Screen (NEW) -->
        <div id="room-view-screen" class="full-screen-overlay bg-background-light dark:bg-background-dark p-4">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <button onclick="document.getElementById('room-view-screen').classList.remove('active'); showHeader();" class="p-2 bg-white dark:bg-card-dark rounded-full shadow hover:scale-105 transition-transform">
                        <span class="material-symbols-outlined text-slate-800 dark:text-white">arrow_back</span>
                    </button>
                    <h2 class="text-xl font-bold text-slate-900 dark:text-white">Room Details</h2>
                </div>
                <button onclick="openClearRoomTotalDialog()" class="text-sm font-bold text-red-500 hover:text-red-700 transition-colors">Clear</button>
            </div>

            <!-- Top Details Card -->
            <div class="bg-white dark:bg-card-dark p-5 rounded-2xl shadow border border-slate-200 dark:border-slate-700 mb-3">
                <div class="flex justify-between items-start mb-2">
                    <h3 id="rv-name" class="text-2xl font-bold text-slate-800 dark:text-white">Room Name</h3>
                </div>
                <div class="space-y-1 text-sm text-slate-500 dark:text-slate-400 mb-4">
                    <p class="flex items-center gap-2"><span class="material-symbols-outlined text-base">phone</span> <span id="rv-mobile">...</span></p>
                    <p class="flex items-center gap-2"><span class="material-symbols-outlined text-base">location_on</span> <span id="rv-address">...</span></p>
                </div>
                
                <!-- Stats Boxes -->
                <div class="grid grid-cols-3 gap-2">
                    <div class="border-2 border-green-500/30 bg-green-50 dark:bg-green-900/10 rounded-xl p-2 text-center">
                        <p class="text-[8px] text-green-600 dark:text-green-400 font-bold uppercase tracking-wide">Total Payment</p>
                        <h3 class="text-sm font-bold text-green-700 dark:text-green-300 mt-1">₹<span id="rv-total-payment">0</span></h3>
                    </div>
                    <div class="border-2 border-orange-500/30 bg-orange-50 dark:bg-orange-900/10 rounded-xl p-2 text-center">
                        <p class="text-[8px] text-orange-600 dark:text-orange-400 font-bold uppercase tracking-wide">Total Advance</p>
                        <h3 class="text-sm font-bold text-orange-700 dark:text-orange-300 mt-1">₹<span id="rv-total-advance">0</span></h3>
                    </div>
                    <div class="border-2 border-blue-500/30 bg-blue-50 dark:bg-blue-900/10 rounded-xl p-2 text-center">
                        <p class="text-[8px] text-blue-600 dark:text-blue-400 font-bold uppercase tracking-wide">Subtotal</p>
                        <h3 class="text-sm font-bold text-blue-700 dark:text-blue-300 mt-1">₹<span id="rv-subtotal">0</span></h3>
                    </div>
                </div>
            </div>

            <!-- Search Bar & View All -->
            <div class="flex items-center justify-between mb-3">
                <div class="relative group flex-1 mr-3">
                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm group-focus-within:text-primary transition-colors">search</span>
                    <input id="rv-search" class="w-full bg-white dark:bg-card-dark border border-slate-200 dark:border-slate-700 rounded-lg py-2 pl-9 pr-3 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-slate-400 text-xs dark:text-white" placeholder="Search this week" type="text"/>
                </div>
                <button onclick="openRoomViewAll()" class="text-xs font-bold text-primary hover:underline whitespace-nowrap">View All</button>
            </div>

            <!-- Work List View (Weekly) -->
            <div class="flex-1 overflow-y-auto bg-white dark:bg-card-dark rounded-xl shadow-sm border border-slate-100 dark:border-slate-700">
                <div class="p-3 border-b border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 flex justify-between items-center">
                    <p class="text-xs font-semibold text-slate-500 dark:text-slate-400">Current Week (Sun - Sat)</p>
                    <button onclick="shareRoomReport()" class="text-green-600 hover:text-green-700 transition-colors">
                        <span class="material-symbols-outlined text-lg">share</span>
                    </button>
                </div>
                <div id="rv-work-list" class="divide-y divide-slate-100 dark:divide-slate-700">
                    <p class="text-center text-slate-400 text-sm py-10">Loading history...</p>
                </div>
            </div>
        </div>

        <!-- View All History Screen -->
        <div id="view-all-history-screen" class="full-screen-overlay bg-background-light dark:bg-background-dark p-4">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <button onclick="document.getElementById('view-all-history-screen').classList.remove('active'); cancelHistorySelection();" class="p-2 bg-white dark:bg-card-dark rounded-full shadow hover:scale-105 transition-transform">
                        <span class="material-symbols-outlined text-slate-800 dark:text-white">arrow_back</span>
                    </button>
                    <h2 class="text-xl font-bold text-slate-900 dark:text-white">All History</h2>
                </div>
                <button id="history-select-all-btn" onclick="selectAllHistory()" class="text-primary text-sm font-bold hidden">Select All</button>
            </div>
            
            <!-- Summary Header for All History (Added) -->
            <div id="all-history-stats" class="grid grid-cols-3 gap-2 mb-3">
                <!-- JS will populate -->
            </div>

            <div class="flex-1 overflow-y-auto bg-white dark:bg-card-dark rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 relative">
                <div id="all-history-list" class="flex flex-col pb-20">
                    <p class="text-center text-slate-400 text-sm py-10">Loading all history...</p>
                </div>
            </div>

            <!-- Floating Action Dialog for History Selection -->
            <div id="history-floating-dialog" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-white dark:bg-card-dark shadow-2xl rounded-full px-6 py-3 flex items-center gap-6 z-50 hidden border border-slate-200 dark:border-slate-700 fade-in-up">
                <button onclick="cancelHistorySelection()" class="text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
                <div class="w-px h-6 bg-slate-200 dark:bg-slate-700"></div>
                <button onclick="editSelectedHistory()" class="text-blue-500 hover:text-blue-700 transition-colors">
                    <span class="material-symbols-outlined">edit</span>
                </button>
                <button onclick="deleteSelectedHistory()" class="text-red-500 hover:text-red-700 transition-colors">
                    <span class="material-symbols-outlined">delete</span>
                </button>
            </div>
        </div>

        <!-- Notification Screen -->
        <div id="notification-screen" class="full-screen-overlay bg-background-light dark:bg-background-dark p-4">
            <div class="flex items-center gap-3 mb-6">
                <button id="back-notification-btn" class="p-2 bg-white dark:bg-card-dark rounded-full shadow hover:scale-105 transition-transform">
                    <span class="material-symbols-outlined text-slate-800 dark:text-white">arrow_back</span>
                </button>
                <h2 class="text-xl font-bold text-slate-900 dark:text-white">Notifications</h2>
            </div>
            <div id="notification-list" class="space-y-3 overflow-x-hidden">
                <!-- JS will populate this -->
                <p class="text-center text-slate-400 text-sm py-10">Loading notifications...</p>
            </div>
        </div>

        <!-- Notification Details Screen -->
        <div id="notification-details-screen" class="full-screen-overlay bg-background-light dark:bg-background-dark p-4">
            <div class="flex items-center gap-3 mb-6">
                <button onclick="document.getElementById('notification-details-screen').classList.remove('active')" class="p-2 bg-white dark:bg-card-dark rounded-full shadow hover:scale-105 transition-transform">
                    <span class="material-symbols-outlined text-slate-800 dark:text-white">arrow_back</span>
                </button>
                <h2 class="text-xl font-bold text-slate-900 dark:text-white">Details</h2>
            </div>
            
            <div class="bg-white dark:bg-card-dark p-6 rounded-2xl shadow border border-slate-200 dark:border-slate-700">
                <img id="nd-image" src="" class="w-full h-48 object-cover rounded-xl mb-4 hidden">
                <span id="nd-date" class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 block">...</span>
                <h3 id="nd-title" class="text-2xl font-bold text-slate-800 dark:text-white mb-4">...</h3>
                <p id="nd-desc" class="text-sm text-slate-600 dark:text-slate-300 leading-relaxed mb-6">...</p>
                
                <button id="nd-action-btn" class="w-full py-3 rounded-xl border-2 border-primary text-primary font-bold hover:bg-primary hover:text-white transition-colors hidden">
                    View
                </button>
            </div>
        </div>

        <!-- Select Workplace Screen (New) -->
        <div id="select-workplace-screen" class="full-screen-overlay bg-background-light dark:bg-background-dark p-4">
            <div class="flex items-center gap-3 mb-4">
                <button onclick="document.getElementById('select-workplace-screen').classList.remove('active'); conductorWorkDialog.classList.add('show');" class="p-2 bg-white dark:bg-card-dark rounded-full shadow hover:scale-105 transition-transform">
                    <span class="material-symbols-outlined text-slate-800 dark:text-white">arrow_back</span>
                </button>
                <h2 class="text-xl font-bold text-slate-900 dark:text-white">Select Workplace</h2>
            </div>
            <div class="flex-1 overflow-y-auto bg-white dark:bg-card-dark rounded-xl shadow-sm border border-slate-100 dark:border-slate-700">
                <div id="workplace-list" class="divide-y divide-slate-100 dark:divide-slate-700">
                    <p class="text-center text-slate-400 text-sm py-10">Loading workplaces...</p>
                </div>
            </div>
        </div>

        <!-- Privacy Policy Screen -->
        <div id="privacy-screen" class="full-screen-overlay bg-background-light dark:bg-background-dark p-4">
            <div class="flex items-center gap-3 mb-6">
                <button id="back-privacy-btn" class="p-2 bg-white dark:bg-card-dark rounded-full shadow hover:scale-105 transition-transform">
                    <span class="material-symbols-outlined text-slate-800 dark:text-white">arrow_back</span>
                </button>
                <h2 class="text-xl font-bold text-slate-900 dark:text-white">Privacy Policy</h2>
            </div>
            <div class="prose dark:prose-invert prose-sm w-full bg-white dark:bg-card-dark p-6 rounded-2xl shadow border border-slate-200 dark:border-slate-700">
                <h3>1. Information Collection</h3>
                <p>We collect information you provide directly to us, such as when you create an account, update your profile, or use our services. This includes your name, mobile number, and email address.</p>
                <h3>2. Data Usage</h3>
                <p>We use the information we collect to provide, maintain, and improve our services, including to process transactions and send you related information.</p>
                <h3>3. Data Security</h3>
                <p>We take reasonable measures to help protect information about you from loss, theft, misuse and unauthorized access.</p>
                <h3>4. Contact Us</h3>
                <p>If you have any questions about this Privacy Policy, please contact us.</p>
            </div>
        </div>

        <!-- Terms Condition Screen -->
        <div id="terms-screen" class="full-screen-overlay bg-background-light dark:bg-background-dark p-4">
            <div class="flex items-center gap-3 mb-6">
                <button id="back-terms-btn" class="p-2 bg-white dark:bg-card-dark rounded-full shadow hover:scale-105 transition-transform">
                    <span class="material-symbols-outlined text-slate-800 dark:text-white">arrow_back</span>
                </button>
                <h2 class="text-xl font-bold text-slate-900 dark:text-white">Terms & Conditions</h2>
            </div>
             <div class="prose dark:prose-invert prose-sm w-full bg-white dark:bg-card-dark p-6 rounded-2xl shadow border border-slate-200 dark:border-slate-700">
                <h3>1. Acceptance of Terms</h3>
                <p>By accessing or using our application, you agree to be bound by these Terms and Conditions.</p>
                <h3>2. User Responsibilities</h3>
                <p>You are responsible for your use of the services and for any content you provide, including compliance with applicable laws.</p>
                <h3>3. Modifications</h3>
                <p>We reserve the right to modify these terms at any time. We will provide notice of these changes by updating the date at the top of these terms.</p>
                <h3>4. Termination</h3>
                <p>We may terminate or suspend access to our service immediately, without prior notice or liability, for any reason whatsoever.</p>
            </div>
        </div>

    </main>

    <!-- Floating Action Button -->
    <button id="fab" class="fixed bottom-20 right-6 w-14 h-14 bg-primary text-white rounded-full shadow-lg shadow-primary/30 flex items-center justify-center hover:scale-105 transition-transform active:scale-95 z-50">
        <span class="material-symbols-outlined text-3xl">add</span>
    </button>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white dark:bg-background-dark border-t border-slate-200 dark:border-slate-800 px-2 py-2 z-50">
        <div class="flex items-center justify-around">
            <a href="#" id="labour-tab-nav" class="nav-link flex flex-col items-center gap-1 p-2 active-tab" data-tab="labour-tab">
                <span class="material-symbols-outlined">hard_drive</span>
                <span class="text-[10px] font-semibold uppercase tracking-wider">Labour</span>
            </a>
            <a href="#" class="nav-link flex flex-col items-center gap-1 p-2 text-slate-400 dark:text-slate-500 hover:text-primary transition-colors" data-tab="conductor-tab">
                <span class="material-symbols-outlined">groups</span>
                <span class="text-[10px] font-semibold uppercase tracking-wider">Conductor</span>
            </a>
            <a href="#" class="nav-link flex flex-col items-center gap-1 p-2 text-slate-400 dark:text-slate-500 hover:text-primary transition-colors" data-tab="room-tab">
                <span class="material-symbols-outlined">door_open</span>
                <span class="text-[10px] font-semibold uppercase tracking-wider">Room</span>
            </a>
            <a href="#" class="nav-link flex flex-col items-center gap-1 p-2 text-slate-400 dark:text-slate-500 hover:text-primary transition-colors" data-tab="profile-tab">
                <span class="material-symbols-outlined">account_circle</span>
                <span class="text-[10px] font-semibold uppercase tracking-wider">Profile</span>
            </a>
        </div>
    </nav>
</div>

<!-- Toast Box -->
<div id="toast-box"></div>

<!-- Dialogs -->
<div id="labour-dialog-overlay" class="dialog-overlay">
    <div class="dialog-content">
        <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white">Add New Labour</h3>
        <form id="add-labour-form">
            <input type="text" id="labour-name" placeholder="Name" class="w-full mb-3 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-3 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-slate-400 text-sm text-slate-900 dark:text-white" required>
            <input type="tel" id="labour-mobile" placeholder="Mobile" class="w-full mb-3 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-3 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-slate-400 text-sm text-slate-900 dark:text-white" required>
            <input type="text" id="labour-address" placeholder="Address" class="w-full mb-3 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-3 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-slate-400 text-sm text-slate-900 dark:text-white" required>
            <input type="number" id="labour-amount" placeholder="Amount" class="w-full mb-4 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-3 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-slate-400 text-sm text-slate-900 dark:text-white" required>
            <div class="flex gap-2">
                <button type="button" id="close-labour-dialog-btn" class="w-full bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">Cancel</button>
                <button type="submit" class="w-full bg-primary text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">Save Data</button>
            </div>
        </form>
    </div>
</div>

<div id="conductor-dialog-overlay" class="dialog-overlay">
    <div class="dialog-content">
        <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white">Add New Conductor</h3>
        <form id="add-conductor-form">
            <input type="text" id="conductor-name" placeholder="Name" class="w-full mb-3 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-3 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-slate-400 text-sm text-slate-900 dark:text-white" required>
            <input type="tel" id="conductor-mobile" placeholder="Mobile" class="w-full mb-3 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-3 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-slate-400 text-sm text-slate-900 dark:text-white" required>
            <input type="text" id="conductor-address" placeholder="Address" class="w-full mb-3 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-3 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-slate-400 text-sm text-slate-900 dark:text-white" required>
            <input type="number" id="conductor-amount" placeholder="Amount" class="w-full mb-4 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-3 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-slate-400 text-sm text-slate-900 dark:text-white" required>
            <div class="flex gap-2">
                <button type="button" id="close-conductor-dialog-btn" class="w-full bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">Cancel</button>
                <button type="submit" class="w-full bg-primary text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">Save Data</button>
            </div>
        </form>
    </div>
</div>

<div id="room-dialog-overlay" class="dialog-overlay">
    <div class="dialog-content">
        <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white">Add New Room</h3>
        <form id="add-room-form">
            <input type="text" id="room-name" placeholder="Name" class="w-full mb-3 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-3 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-slate-400 text-sm text-slate-900 dark:text-white" required>
            <input type="tel" id="room-mobile" placeholder="Mobile" class="w-full mb-3 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-3 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-slate-400 text-sm text-slate-900 dark:text-white" required>
            <input type="text" id="room-address" placeholder="Address (Optional)" class="w-full mb-3 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-3 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-slate-400 text-sm text-slate-900 dark:text-white">
            <input type="number" id="room-amount" placeholder="Amount" class="w-full mb-4 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-3 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-slate-400 text-sm text-slate-900 dark:text-white" required>
            <div class="flex gap-2">
                <button type="button" id="close-room-dialog-btn" class="w-full bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">Cancel</button>
                <button type="submit" class="w-full bg-primary text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">Save Data</button>
            </div>
        </form>
    </div>
</div>

<!-- NEW: Add Labour Work Dialog -->
<div id="labour-work-dialog" class="dialog-overlay">
    <div class="dialog-content">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-slate-900 dark:text-white">Add Labour Work</h3>
            <div class="relative">
                <select id="labour-work-type-dropdown" class="text-sm appearance-none bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg py-1 pl-3 pr-8 focus:outline-none focus:ring-2 focus:ring-primary/20">
                    <option value="full" selected>Full Day</option>
                    <option value="half">Half Day</option>
                    <option value="custom">Custom</option>
                </select>
                <span class="material-symbols-outlined absolute right-2 top-1/2 -translate-y-1/2 text-slate-500 text-base pointer-events-none">expand_more</span>
            </div>
        </div>
        
        <div id="labour-custom-amount-container" class="hidden mb-4">
             <input type="number" id="labour-custom-amount-input" placeholder="Enter Custom Amount" class="w-full bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-3 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-slate-400 text-sm text-slate-900 dark:text-white">
        </div>

        <div class="flex gap-2">
            <button onclick="document.getElementById('labour-work-dialog').classList.remove('show')" class="w-full bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">Cancel</button>
            <button id="save-labour-work-btn" class="w-full bg-primary text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">Save</button>
        </div>
    </div>
</div>

<!-- Conductor Work Dialog (MODIFIED) -->
<div id="conductor-work-dialog" class="dialog-overlay">
    <div class="dialog-content">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-slate-900 dark:text-white">Add Conductor Work</h3>
            <div class="relative">
                <select id="work-type-dropdown" class="text-sm appearance-none bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg py-1 pl-3 pr-8 focus:outline-none focus:ring-2 focus:ring-primary/20">
                    <option value="full" selected>Full Day</option>
                    <option value="half">Half Day</option>
                    <option value="custom">Custom</option>
                </select>
                <span class="material-symbols-outlined absolute right-2 top-1/2 -translate-y-1/2 text-slate-500 text-base pointer-events-none">expand_more</span>
            </div>
        </div>

        <input type="number" id="conductor-trip-count" placeholder="Enter Number (e.g. Trips)" class="w-full mb-3 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-3 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-slate-400 text-sm text-slate-900 dark:text-white">
        
        <div id="custom-amount-container" class="hidden mb-3">
             <input type="number" id="conductor-custom-amount" placeholder="Enter Custom Amount" class="w-full bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-3 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-slate-400 text-sm text-slate-900 dark:text-white">
        </div>

        <div class="flex gap-2 mb-4">
            <input type="text" id="workplace-input" readonly placeholder="Select Workplace" onclick="openSelectWorkplaceScreen()" class="w-full bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-3 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-slate-400 text-sm text-slate-900 dark:text-white cursor-pointer">
            <button onclick="openAddWorkplaceDialog()" class="bg-primary text-white px-4 rounded-lg font-bold text-xl shadow-lg shadow-orange-500/30">+</button>
        </div>

        <div class="flex gap-2">
            <button onclick="document.getElementById('conductor-work-dialog').classList.remove('show')" class="w-full bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">Cancel</button>
            <button id="save-conductor-work-btn" class="w-full bg-primary text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">Save</button>
        </div>
    </div>
</div>

<!-- Add Workplace Dialog -->
<div id="add-workplace-dialog" class="dialog-overlay">
    <div class="dialog-content">
        <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white">Add New Workplace</h3>
        <input type="text" id="new-workplace-name" placeholder="Workplace Name" class="w-full mb-4 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-3 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-slate-400 text-sm text-slate-900 dark:text-white">
        <div class="flex gap-2">
            <button onclick="document.getElementById('add-workplace-dialog').classList.remove('show')" class="w-full bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">Cancel</button>
            <button onclick="saveWorkplace()" class="w-full bg-primary text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">Save</button>
        </div>
    </div>
</div>

<!-- Select Workplace Screen -->
<div id="select-workplace-screen" class="full-screen-overlay bg-background-light dark:bg-background-dark p-4">
    <div class="flex items-center gap-3 mb-4">
        <button onclick="document.getElementById('select-workplace-screen').classList.remove('active'); conductorWorkDialog.classList.add('show');" class="p-2 bg-white dark:bg-card-dark rounded-full shadow hover:scale-105 transition-transform">
            <span class="material-symbols-outlined text-slate-800 dark:text-white">arrow_back</span>
        </button>
        <h2 class="text-xl font-bold text-slate-900 dark:text-white">Select Workplace</h2>
    </div>
    <div class="flex-1 overflow-y-auto bg-white dark:bg-card-dark rounded-xl shadow-sm border border-slate-100 dark:border-slate-700">
        <div id="workplace-list" class="divide-y divide-slate-100 dark:divide-slate-700">
            <p class="text-center text-slate-400 text-sm py-10">Loading workplaces...</p>
        </div>
    </div>
</div>

<!-- Work PIN Dialog -->
<div id="work-pin-dialog-overlay" class="dialog-overlay">
    <div class="dialog-content">
        <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white">Enter MPIN</h3>
        <input type="number" id="work-mpin-input" maxlength="4" placeholder="4 Digit PIN" class="w-full mb-4 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-3 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-slate-400 text-sm text-slate-900 dark:text-white text-center tracking-widest text-xl">
        <button id="submit-work-btn" class="w-full bg-primary text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity mb-3">Submit</button>
        <p class="text-center text-sm text-primary cursor-pointer hover:underline" onclick="openCreateMpinDialog()">Create PIN</p>
        <button onclick="document.getElementById('work-pin-dialog-overlay').classList.remove('show')" class="w-full mt-3 text-slate-500 text-sm">Cancel</button>
    </div>
</div>

<!-- Create MPIN Dialog -->
<div id="create-mpin-dialog-overlay" class="dialog-overlay">
    <div class="dialog-content">
        <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white">Set New MPIN</h3>
        <input type="tel" id="verify-mobile-input" placeholder="Enter Mobile Number" class="w-full mb-3 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-3 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-slate-400 text-sm text-slate-900 dark:text-white">
        <input type="password" id="new-mpin-input" maxlength="4" placeholder="New 4 Digit PIN" class="w-full mb-4 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-3 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-slate-400 text-sm text-slate-900 dark:text-white text-center tracking-widest text-xl">
        <button id="update-mpin-btn" class="w-full bg-primary text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">Update</button>
        <button onclick="document.getElementById('create-mpin-dialog-overlay').classList.remove('show')" class="w-full mt-3 text-slate-500 text-sm">Cancel</button>
    </div>
</div>

<!-- Delete Labour Confirmation Dialog -->
<div id="delete-labour-dialog" class="dialog-overlay">
    <div class="dialog-content">
        <h3 class="text-lg font-bold mb-2 text-slate-900 dark:text-white">Delete Labour?</h3>
        <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">Are you sure you want to delete this labour? This action cannot be undone.</p>
        <div class="flex gap-2">
            <button onclick="document.getElementById('delete-labour-dialog').classList.remove('show')" class="w-full bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">Cancel</button>
            <button id="btn-delete-confirm" class="w-full bg-red-500 text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">Delete</button>
        </div>
    </div>
</div>

<!-- Delete Conductor Confirmation Dialog (NEW) -->
<div id="delete-conductor-dialog" class="dialog-overlay">
    <div class="dialog-content">
        <h3 class="text-lg font-bold mb-2 text-slate-900 dark:text-white">Delete Conductor?</h3>
        <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">Are you sure you want to delete this conductor? This action cannot be undone.</p>
        <div class="flex gap-2">
            <button onclick="document.getElementById('delete-conductor-dialog').classList.remove('show')" class="w-full bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">Cancel</button>
            <button id="btn-delete-conductor-confirm" class="w-full bg-red-500 text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">Delete</button>
        </div>
    </div>
</div>

<!-- Delete Room Confirmation Dialog (NEW) -->
<div id="delete-room-dialog" class="dialog-overlay">
    <div class="dialog-content">
        <h3 class="text-lg font-bold mb-2 text-slate-900 dark:text-white">Delete Room?</h3>
        <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">Are you sure you want to delete this room? This action cannot be undone.</p>
        <div class="flex gap-2">
            <button onclick="document.getElementById('delete-room-dialog').classList.remove('show')" class="w-full bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">Cancel</button>
            <button id="btn-delete-room-confirm" class="w-full bg-red-500 text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">Delete</button>
        </div>
    </div>
</div>

<!-- Advance Dialog (New) -->
<div id="advance-dialog-overlay" class="dialog-overlay">
    <div class="dialog-content">
        <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white">Add Advance</h3>
        <input type="number" id="advance-amount-input" placeholder="Enter Amount" class="w-full mb-4 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-3 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-slate-400 text-sm text-slate-900 dark:text-white">
        <div class="flex gap-2">
            <button onclick="document.getElementById('advance-dialog-overlay').classList.remove('show')" class="w-full bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">Cancel</button>
            <button id="save-advance-btn" class="w-full bg-primary text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">Save</button>
        </div>
    </div>
</div>

<!-- Delete Work Item Dialog -->
<div id="delete-work-item-dialog" class="dialog-overlay">
    <div class="dialog-content">
        <h3 class="text-lg font-bold mb-2 text-slate-900 dark:text-white">Delete Entry?</h3>
        <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">Are you sure you want to delete this entry?</p>
        <div class="flex gap-2">
            <button onclick="document.getElementById('delete-work-item-dialog').classList.remove('show')" class="w-full bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">Cancel</button>
            <button id="btn-delete-work-confirm" class="w-full bg-red-500 text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">Delete</button>
        </div>
    </div>
</div>

<!-- Clear Total Dialog -->
<div id="clear-total-dialog" class="dialog-overlay">
    <div class="dialog-content">
        <h3 class="text-lg font-bold mb-2 text-slate-900 dark:text-white">Clear All Work?</h3>
        <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">This will delete all work history for this labour. This cannot be undone.</p>
        <div class="flex gap-2">
            <button onclick="document.getElementById('clear-total-dialog').classList.remove('show')" class="w-full bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">Cancel</button>
            <button id="btn-clear-total-confirm" class="w-full bg-red-500 text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">Clear All</button>
        </div>
    </div>
</div>

<!-- Clear Advance Dialog -->
<div id="clear-advance-dialog" class="dialog-overlay">
    <div class="dialog-content">
        <h3 class="text-lg font-bold mb-2 text-slate-900 dark:text-white">Clear All Advance?</h3>
        <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">This will delete all advance history for this labour. This cannot be undone.</p>
        <div class="flex gap-2">
            <button onclick="document.getElementById('clear-advance-dialog').classList.remove('show')" class="w-full bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">Cancel</button>
            <button id="btn-clear-advance-confirm" class="w-full bg-red-500 text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">Clear All</button>
        </div>
    </div>
</div>

<!-- Clear Conductor Total Dialog (New) -->
<div id="clear-conductor-total-dialog" class="dialog-overlay">
    <div class="dialog-content">
        <h3 class="text-lg font-bold mb-2 text-slate-900 dark:text-white">Clear Conductor History?</h3>
        <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">This will delete all history for this conductor. This cannot be undone.</p>
        <div class="flex gap-2">
            <button onclick="document.getElementById('clear-conductor-total-dialog').classList.remove('show')" class="w-full bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">Cancel</button>
            <button id="btn-clear-conductor-total-confirm" class="w-full bg-red-500 text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">Clear All</button>
        </div>
    </div>
</div>

<!-- Clear Room Total Dialog (New for Room Tab) -->
<div id="clear-room-total-dialog" class="dialog-overlay">
    <div class="dialog-content">
        <h3 class="text-lg font-bold mb-2 text-slate-900 dark:text-white">Clear Room History?</h3>
        <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">This will delete all history for this room. This cannot be undone.</p>
        <div class="flex gap-2">
            <button onclick="document.getElementById('clear-room-total-dialog').classList.remove('show')" class="w-full bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">Cancel</button>
            <button id="btn-clear-room-total-confirm" class="w-full bg-red-500 text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">Clear All</button>
        </div>
    </div>
</div>

<!-- Edit History Item Dialog (NEW) -->
<div id="edit-history-dialog" class="dialog-overlay">
    <div class="dialog-content">
        <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white">Edit Amount</h3>
        <input type="number" id="edit-history-amount" placeholder="Enter New Amount" class="w-full mb-4 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-3 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all placeholder:text-slate-400 text-sm text-slate-900 dark:text-white">
        <div class="flex gap-2">
            <button onclick="document.getElementById('edit-history-dialog').classList.remove('show')" class="w-full bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">Cancel</button>
            <button id="save-edit-history-btn" class="w-full bg-primary text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">Update</button>
        </div>
    </div>
</div>

<!-- NEW: Clear Selection Dialog for Labour View -->
<div id="clear-selection-dialog" class="dialog-overlay">
    <div class="dialog-content fade-in-up">
        <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white">Clear History</h3>
        <div class="space-y-3">
            <div onclick="performClear('work')" class="p-4 bg-slate-50 dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 flex items-center justify-between cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                <span class="font-semibold text-slate-800 dark:text-white">Clear Total Work Amount</span>
                <span class="material-symbols-outlined text-slate-400">delete</span>
            </div>
            <div onclick="performClear('advance')" class="p-4 bg-slate-50 dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 flex items-center justify-between cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                <span class="font-semibold text-slate-800 dark:text-white">Clear Total Advance Amount</span>
                <span class="material-symbols-outlined text-slate-400">delete</span>
            </div>
        </div>
        <button onclick="document.getElementById('clear-selection-dialog').classList.remove('show')" class="w-full mt-6 bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">Cancel</button>
    </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
    // Firebase Config
    const firebaseConfig = {
            apiKey: "AIzaSyBQHKJvI_FBqClddSho75Xz6w4vjXbt_w0",
            authDomain: "spin-and-win-d4217.firebaseapp.com",
            databaseURL: "https://spin-and-win-d4217-default-rtdb.firebaseio.com",
            projectId: "spin-and-win-d4217",
            storageBucket: "spin-and-win-d4217.firebasestorage.app",
            messagingSenderId: "1000691452468",
            appId: "1:1000691452468:web:723e6e050faf6423e99861"
        };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();
    let currentUserId = null;
    let currentUserPromo = "";
    let dynamicShareLink = "https://shorturl.at/opck6"; // Default link
    
    // Work/Advance Logic Variables
    let selectedLabourKey = null;
    let selectedLabourName = null;
    let selectedLabourAmount = null; // This will hold the FINAL calculated amount for work
    let baseLabourAmount = null; // This will hold the original full day amount
    let deleteLabourKey = null;
    let deleteConductorKey = null; // New for Conductor Delete
    let deleteRoomKey = null; // New for Room Delete
    
    // Conductor Logic Variables
    let currentConductorKey = null;
    let currentConductorName = null;
    let currentConductorBaseAmount = null;
    let selectedWorkplace = null;
    
    // Room Logic Variables
    let currentRoomKey = null;
    let currentRoomName = null;
    let currentRoomAmount = null;
    
    // New variables for Advance logic
    let currentActionType = ''; // 'work', 'advance', 'nowork', 'clear_work', 'clear_advance', 'conductor_work', 'room_payment', 'room_advance'
    let tempAdvanceAmount = 0;
    
    // Labour View Variables
    let currentLabourViewName = null;
    let currentLabourViewKey = null; // Added to track key for clearing
    let currentLabourViewMobile = null; // Added for share functionality
    let deleteWorkItemKey = null;
    let currentWeeklyData = []; // Store weekly data for sharing
    
    // Conductor View Variables
    let currentConductorViewName = null;
    let currentConductorViewMobile = null;
    let currentConductorWeeklyData = [];
    
    // Room View Variables
    let currentRoomViewName = null;
    let currentRoomViewMobile = null;
    let currentRoomWeeklyData = [];
    
    // Withdrawal Variables
    let currentBankData = null;
    
    // Update Profile Variables
    const updateProfileScreen = document.getElementById('update-profile-screen');
    const saveProfileBtn = document.getElementById('save-profile-btn');
    
    // History Selection Variables
    let selectedHistoryKeys = [];
    let longPressTimer;
    let currentHistoryContext = ''; // 'labour', 'conductor', 'room'

    // Elements
    const authScreen = document.getElementById('auth-screen');
    const appScreen = document.getElementById('app-screen');
    const mainHeader = document.getElementById('main-header');
    
    // Auth Form
    const authButton = document.getElementById('authButton');
    const logoutBtn = document.getElementById('logout-btn');
    const authError = document.getElementById('auth-error');
    const nameInput = document.getElementById('name');
    const mobileInput = document.getElementById('mobile');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const registerFields = document.getElementById('register-fields');
    const toggleText = document.getElementById('toggleText');
    const headerTitle = document.getElementById('header-title');

    // Dialogs
    const fab = document.getElementById('fab');
    const labourDialogOverlay = document.getElementById('labour-dialog-overlay');
    const closeLabourDialogBtn = document.getElementById('close-labour-dialog-btn');
    const addLabourForm = document.getElementById('add-labour-form');
    const labourGrid = document.getElementById('labour-grid');
    
    const conductorDialogOverlay = document.getElementById('conductor-dialog-overlay');
    const closeConductorDialogBtn = document.getElementById('close-conductor-dialog-btn');
    const addConductorForm = document.getElementById('add-conductor-form');
    const conductorGrid = document.getElementById('conductor-grid');

    const roomDialogOverlay = document.getElementById('room-dialog-overlay');
    const closeRoomDialogBtn = document.getElementById('close-room-dialog-btn');
    const addRoomForm = document.getElementById('add-room-form');
    const roomGrid = document.getElementById('room-grid');
    
    // Labour Work Dialog (NEW)
    const labourWorkDialog = document.getElementById('labour-work-dialog');
    const labourWorkTypeDropdown = document.getElementById('labour-work-type-dropdown');
    const labourCustomAmountContainer = document.getElementById('labour-custom-amount-container');
    const labourCustomAmountInput = document.getElementById('labour-custom-amount-input');
    const saveLabourWorkBtn = document.getElementById('save-labour-work-btn');

    // Work Dialogs
    const workPinDialogOverlay = document.getElementById('work-pin-dialog-overlay');
    const createMpinDialogOverlay = document.getElementById('create-mpin-dialog-overlay');
    const workMpinInput = document.getElementById('work-mpin-input');
    const submitWorkBtn = document.getElementById('submit-work-btn');
    const verifyMobileInput = document.getElementById('verify-mobile-input');
    const newMpinInput = document.getElementById('new-mpin-input');
    const updateMpinBtn = document.getElementById('update-mpin-btn');
    
    // Conductor Work Dialog
    const conductorWorkDialog = document.getElementById('conductor-work-dialog');
    const conductorTripCount = document.getElementById('conductor-trip-count');
    const workplaceInput = document.getElementById('workplace-input');
    const saveConductorWorkBtn = document.getElementById('save-conductor-work-btn');
    const workTypeDropdown = document.getElementById('work-type-dropdown');
    const customAmountContainer = document.getElementById('custom-amount-container');
    const conductorCustomAmount = document.getElementById('conductor-custom-amount');
    
    // Workplace Dialogs
    const addWorkplaceDialog = document.getElementById('add-workplace-dialog');
    const newWorkplaceName = document.getElementById('new-workplace-name');
    const selectWorkplaceScreen = document.getElementById('select-workplace-screen');
    const workplaceList = document.getElementById('workplace-list');

    // Advance Dialog
    const advanceDialogOverlay = document.getElementById('advance-dialog-overlay');
    const advanceAmountInput = document.getElementById('advance-amount-input');
    const saveAdvanceBtn = document.getElementById('save-advance-btn');

    // Delete Dialogs
    const deleteLabourDialog = document.getElementById('delete-labour-dialog');
    const btnDeleteConfirm = document.getElementById('btn-delete-confirm');
    const deleteConductorDialog = document.getElementById('delete-conductor-dialog'); // New
    const btnDeleteConductorConfirm = document.getElementById('btn-delete-conductor-confirm'); // New
    const deleteRoomDialog = document.getElementById('delete-room-dialog'); // New
    const btnDeleteRoomConfirm = document.getElementById('btn-delete-room-confirm'); // New
    const deleteWorkItemDialog = document.getElementById('delete-work-item-dialog');
    const btnDeleteWorkConfirm = document.getElementById('btn-delete-work-confirm');
    const clearTotalDialog = document.getElementById('clear-total-dialog');
    const btnClearTotalConfirm = document.getElementById('btn-clear-total-confirm');
    const clearAdvanceDialog = document.getElementById('clear-advance-dialog');
    const btnClearAdvanceConfirm = document.getElementById('btn-clear-advance-confirm');
    const clearConductorTotalDialog = document.getElementById('clear-conductor-total-dialog');
    const btnClearConductorTotalConfirm = document.getElementById('btn-clear-conductor-total-confirm');
    const clearRoomTotalDialog = document.getElementById('clear-room-total-dialog');
    const btnClearRoomTotalConfirm = document.getElementById('btn-clear-room-total-confirm');
    
    // Menu & Screens
    const themeToggle = document.getElementById('theme-toggle');
    const referMenuBtn = document.getElementById('refer-menu-btn');
    const privacyMenuBtn = document.getElementById('privacy-menu-btn');
    const termsMenuBtn = document.getElementById('terms-menu-btn');
    
    const referScreen = document.getElementById('refer-screen');
    const privacyScreen = document.getElementById('privacy-screen');
    const termsScreen = document.getElementById('terms-screen');
    const labourViewScreen = document.getElementById('labour-view-screen');
    const conductorViewScreen = document.getElementById('conductor-view-screen');
    const roomViewScreen = document.getElementById('room-view-screen');
    const viewAllHistoryScreen = document.getElementById('view-all-history-screen');
    const conductorHistoryScreen = document.getElementById('conductor-history-screen');
    
    // New Screens
    const withdrawalScreen = document.getElementById('withdrawal-screen');
    const withdrawalHistoryScreen = document.getElementById('withdrawal-history-screen');
    const addBankDialog = document.getElementById('add-bank-dialog');
    
    const backReferBtn = document.getElementById('back-refer-btn');
    const backPrivacyBtn = document.getElementById('back-privacy-btn');
    const backTermsBtn = document.getElementById('back-terms-btn');
    const backLabourViewBtn = document.getElementById('back-labour-view-btn');
    const backConductorHistoryBtn = document.getElementById('back-conductor-history-btn');
    const backWithdrawBtn = document.getElementById('back-withdraw-btn');
    const backWithdrawHistoryBtn = document.getElementById('back-withdraw-history-btn');

    // Notification Screen Elements
    const notificationScreen = document.getElementById('notification-screen');
    const notificationDetailsScreen = document.getElementById('notification-details-screen');
    const notificationBellBtn = document.getElementById('notification-bell-btn');
    const backNotificationBtn = document.getElementById('back-notification-btn');
    const notificationList = document.getElementById('notification-list');
    
    // Refer Logic Elements
    const submitReferBtn = document.getElementById('submit-refer-btn');
    const referralInput = document.getElementById('referral-input');
    const referMsg = document.getElementById('refer-msg');
    const walletBalanceEl = document.getElementById('wallet-balance');
    const myPromoCodeEl = document.getElementById('my-promo-code');
    const copyCodeBtn = document.getElementById('copy-code-btn');
    const toastBox = document.getElementById('toast-box');
    const totalReferralsCountEl = document.getElementById('total-referrals-count');
    const totalEarningsCountEl = document.getElementById('total-earnings-count');
    
    // Withdraw Logic Elements
    const openWithdrawBtn = document.getElementById('open-withdraw-btn');
    const withdrawBalanceEl = document.getElementById('withdraw-balance');
    const bankBox = document.getElementById('bank-box');
    const bankInfoDisplay = document.getElementById('bank-info-display');
    const withdrawAmountInput = document.getElementById('withdraw-amount-input');
    const finalWithdrawBtn = document.getElementById('final-withdraw-btn');
    const amountChips = document.querySelectorAll('.amount-chip');
    const saveBankBtn = document.getElementById('save-bank-btn');
    const openWithdrawHistoryBtn = document.getElementById('open-withdraw-history');
    const withdrawalList = document.getElementById('withdrawal-list');
    const historyTabs = document.querySelectorAll('.history-tab');
    
    // Search Inputs
    const labourSearchInput = document.getElementById('labour-search-input');
    const conductorSearchInput = document.getElementById('conductor-search-input');
    const roomSearchInput = document.getElementById('room-search-input');

    // Indian Banks List
    const indianBanks = [
        "State Bank of India", "HDFC Bank", "ICICI Bank", "Punjab National Bank", 
        "Axis Bank", "Bank of Baroda", "Bank of India", "Canara Bank", 
        "Union Bank of India", "Kotak Mahindra Bank", "IndusInd Bank", "Yes Bank", 
        "IDBI Bank", "Central Bank of India", "Indian Bank", "Indian Overseas Bank", 
        "UCO Bank", "Bank of Maharashtra", "Punjab & Sind Bank", "Federal Bank"
    ];

    let isRegisterMode = true;
    
    // Populate Bank Dropdown
    const bankSelect = document.getElementById('bank-name-select');
    indianBanks.forEach(bank => {
        const option = document.createElement('option');
        option.value = bank;
        option.textContent = bank;
        bankSelect.appendChild(option);
    });
    
    // --- Progress Bar Logic ---
    const progressBar = document.getElementById('progress-bar');
    function showProgress() {
        progressBar.style.display = 'block';
        progressBar.style.width = '0%';
        void progressBar.offsetWidth; 
        progressBar.style.width = '100%';
        
        setTimeout(() => {
            progressBar.style.display = 'none';
            progressBar.style.width = '0%';
        }, 3000);
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        document.body.addEventListener('click', function(e) {
            if (e.target.matches('button')) {
                showProgress();
            }
        });
    });

    // --- Toast Function ---
    function showToast(message) {
        toastBox.textContent = message;
        toastBox.className = "show";
        setTimeout(function(){ toastBox.className = toastBox.className.replace("show", ""); }, 3000);
    }

    // --- Toggle Dropdown Function (Modified for Inline Click) ---
    window.toggleDropdown = function(id) {
        const el = document.getElementById('dropdown-' + id);
        if (el.classList.contains('hidden')) {
            el.classList.remove('hidden');
        } else {
            el.classList.add('hidden');
        }
    }

    // --- Theme Logic ---
    function initTheme() {
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            themeToggle.checked = true;
        } else {
            document.documentElement.classList.remove('dark');
            themeToggle.checked = false;
        }
    }
    initTheme();

    themeToggle.addEventListener('change', function() {
        if(this.checked) {
            document.documentElement.classList.add('dark');
            localStorage.theme = 'dark';
        } else {
            document.documentElement.classList.remove('dark');
            localStorage.theme = 'light';
        }
    });

    // --- Auth State ---
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUserId = user.uid;
            authScreen.style.display = 'none';
            appScreen.classList.remove('hidden');
            appScreen.classList.add('flex');
            
            currentUserPromo = "REF" + user.uid.substring(0,5).toUpperCase();
            myPromoCodeEl.textContent = currentUserPromo;
            
            database.ref(`users/${user.uid}`).once('value').then(snapshot => {
                const userData = snapshot.val();
                if(userData) {
                    const userName = userData.name || user.email.split('@')[0];
                    const userImg = userData.profileimage || "https://lh3.googleusercontent.com/aida-public/AB6AXuAUKvT3-9wsXtOXuexCaR4tiCdUDIasbk5S86_Kb7UTVUKQynrMvwS7CQwGtG-y4bKuEHG0AcZiK38pT0qy4NO4Qk0XTxQ8J-MzZiy5bbfdg38hbjAmggQ2rXdgDFYj47Xa2tfniztNBvpHFcgdDFtNSaQGblhHzy-DsyL5JhFyo-32ust-621SzcqfyL-SENSjuDpfd3lt5q16qZDJwXd8EGbkju_tRw8mNp_IZ9Dja8SuYuW_9QP6u39_ivI5O1WvVJzGQU8szl7C";

                    // Update Top Header
                    document.getElementById('user-name').textContent = userName;
                    document.getElementById('header-profile-img').src = userImg;

                    // Update Wallet Card in Profile Tab
                    document.getElementById('wallet-card-name').textContent = userName;
                    document.getElementById('wallet-card-img').src = userImg;

                    if (!userData.promoCode) {
                        database.ref(`users/${user.uid}`).update({ promoCode: currentUserPromo });
                    }
                }
            });
            
            database.ref(`users/${user.uid}/balance`).on('value', snapshot => {
                const bal = snapshot.val() || 0;
                walletBalanceEl.textContent = bal;
                withdrawBalanceEl.textContent = bal;
            });

            // Fetch Share Link from Settings
            database.ref('settings/shareLink').on('value', snapshot => {
                const val = snapshot.val();
                if(val) dynamicShareLink = val;
            });
            
            // Listen for Bank Details
            database.ref(`users/${user.uid}/bank`).on('value', snapshot => {
                const bank = snapshot.val();
                if (bank) {
                    currentBankData = bank;
                    bankInfoDisplay.innerHTML = `
                        <p class="text-sm font-bold text-slate-800 dark:text-white">${bank.bankName}</p>
                        <p class="text-xs text-slate-500 font-mono">****${bank.accountNumber.slice(-4)}</p>
                    `;
                } else {
                    currentBankData = null;
                    bankInfoDisplay.innerHTML = `
                        <p class="text-sm font-bold text-primary">Add Bank Account</p>
                        <p class="text-xs text-slate-400">To withdraw funds</p>
                    `;
                }
            });
            
            loadReferralStats();
            loadLabourData();
            loadConductorData();
            loadRoomData();
            loadNotifications();
        } else {
            currentUserId = null;
            authScreen.style.display = 'flex';
            appScreen.classList.add('hidden');
            appScreen.classList.remove('flex');
        }
    });

    // --- Auth Buttons ---
    toggleText.addEventListener('click', () => {
        isRegisterMode = !isRegisterMode;
        authError.textContent = '';
        if (isRegisterMode) {
            registerFields.classList.remove('hidden-field');
            authButton.textContent = "Register";
            toggleText.innerHTML = `Already have an account? <span class="text-primary font-bold">Login</span>`;
            headerTitle.innerHTML = "Here's<br/>your first<br/>step with<br/>us!";
        } else {
            registerFields.classList.add('hidden-field');
            authButton.textContent = "Login";
            toggleText.innerHTML = `Don't have an account? <span class="text-primary font-bold">Register</span>`;
            headerTitle.innerHTML = "Welcome<br/>Back!<br/><br/>";
        }
    });

    authButton.addEventListener('click', () => {
        const email = emailInput.value;
        const password = passwordInput.value;
        authError.textContent = '';

        if (isRegisterMode) {
            const name = nameInput.value;
            const mobile = mobileInput.value;
            
            if (!name || !mobile || !email || !password) {
                authError.textContent = "Please fill all fields!";
                return;
            }
            
            auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    const user = userCredential.user;
                    const userPromo = "REF" + user.uid.substring(0,5).toUpperCase();
                    database.ref('users/' + user.uid).set({
                        name: name,
                        mobile: mobile,
                        gmail: email,
                        Password: password,
                        mpin: "",
                        Status: "active",
                        profileimage: "",
                        userid: user.uid,
                        balance: "0",
                        promoCode: userPromo,
                        hasUsedReferral: false
                    });
                })
                .catch(error => { authError.textContent = error.message; });
        } else {
            if (!email || !password) {
                authError.textContent = "Please enter Email and Password!";
                return;
            }
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => { authError.textContent = error.message; });
        }
    });

    logoutBtn.addEventListener('click', () => {
        auth.signOut();
    });

    // --- Screen Navigation ---
    function hideHeader() { mainHeader.style.display = 'none'; }
    function showHeader() { mainHeader.style.display = 'flex'; }

    // Tab Switching
    const navLinks = document.querySelectorAll('.nav-link');
    const tabContents = document.querySelectorAll('.tab-content');
    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const tabId = link.getAttribute('data-tab');
            navLinks.forEach(nav => {
                nav.classList.remove('active-tab');
                nav.classList.add('text-slate-400', 'dark:text-slate-500');
            });
            link.classList.add('active-tab');
            link.classList.remove('text-slate-400', 'dark:text-slate-500');
            tabContents.forEach(content => content.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            if (tabId === 'profile-tab') {
                hideHeader();
                fab.style.display = 'none'; // Hide FAB on Profile Tab
            } else {
                showHeader();
                fab.style.display = 'flex'; // Show FAB on other tabs
            }
        });
    });

    // Sub-Screen Logic
    referMenuBtn.addEventListener('click', () => { referScreen.classList.add('active'); hideHeader(); });
    privacyMenuBtn.addEventListener('click', () => { privacyScreen.classList.add('active'); hideHeader(); });
    termsMenuBtn.addEventListener('click', () => { termsScreen.classList.add('active'); hideHeader(); });

    backReferBtn.addEventListener('click', (e) => { 
        e.stopPropagation(); // Prevent progress bar from triggering again
        referScreen.classList.remove('active'); 
    });
    backPrivacyBtn.addEventListener('click', () => { privacyScreen.classList.remove('active'); });
    backTermsBtn.addEventListener('click', () => { termsScreen.classList.remove('active'); });
    
    backLabourViewBtn.addEventListener('click', () => {
        labourViewScreen.classList.remove('active');
        showHeader();
    });
    
    backConductorHistoryBtn.addEventListener('click', () => {
        conductorHistoryScreen.classList.remove('active');
        showHeader();
    });

    // --- Update Profile Logic ---
    window.openUpdateProfileScreen = function() {
        updateProfileScreen.classList.add('active');
        hideHeader();
        
        // Fetch current data to populate form
        if(currentUserId) {
            database.ref(`users/${currentUserId}`).once('value').then(snapshot => {
                const data = snapshot.val();
                if(data) {
                    document.getElementById('update-name').value = data.name || '';
                    document.getElementById('update-mobile').value = data.mobile || '';
                    document.getElementById('update-email').value = data.gmail || '';
                    document.getElementById('update-password').value = data.Password || '';
                    document.getElementById('update-mpin').value = data.mpin || '';
                    document.getElementById('update-profile-url').value = data.profileimage || '';
                    document.getElementById('update-profile-img-preview').src = data.profileimage || 'https://lh3.googleusercontent.com/aida-public/AB6AXuAUKvT3-9wsXtOXuexCaR4tiCdUDIasbk5S86_Kb7UTVUKQynrMvwS7CQwGtG-y4bKuEHG0AcZiK38pT0qy4NO4Qk0XTxQ8J-MzZiy5bbfdg38hbjAmggQ2rXdgDFYj47Xa2tfniztNBvpHFcgdDFtNSaQGblhHzy-DsyL5JhFyo-32ust-621SzcqfyL-SENSjuDpfd3lt5q16qZDJwXd8EGbkju_tRw8mNp_IZ9Dja8SuYuW_9QP6u39_ivI5O1WvVJzGQU8szl7C';
                }
            });
        }
    };
    
    document.getElementById('update-profile-url').addEventListener('input', function() {
        const url = this.value;
        if(url) {
             document.getElementById('update-profile-img-preview').src = url;
        }
    });

    saveProfileBtn.addEventListener('click', () => {
        if(!currentUserId) return;
        
        const newName = document.getElementById('update-name').value.trim();
        const newMobile = document.getElementById('update-mobile').value.trim();
        const newPass = document.getElementById('update-password').value.trim();
        const newMpin = document.getElementById('update-mpin').value.trim();
        const newImg = document.getElementById('update-profile-url').value.trim();

        const updates = {
            name: newName,
            mobile: newMobile,
            Password: newPass,
            mpin: newMpin,
            profileimage: newImg
        };

        database.ref(`users/${currentUserId}`).update(updates)
            .then(() => {
                showToast("Profile Updated Successfully!");
                updateProfileScreen.classList.remove('active');
                
                // Refresh local UI instantly
                document.getElementById('user-name').textContent = newName;
                document.getElementById('wallet-card-name').textContent = newName;
                if(newImg) {
                    document.getElementById('header-profile-img').src = newImg;
                    document.getElementById('wallet-card-img').src = newImg;
                }
            })
            .catch((error) => {
                alert("Error updating profile: " + error.message);
            });
    });


    // --- Notification Logic ---
    notificationBellBtn.addEventListener('click', () => {
        notificationScreen.classList.add('active');
        hideHeader();
    });

    backNotificationBtn.addEventListener('click', () => {
        notificationScreen.classList.remove('active');
        showHeader();
    });

    function loadNotifications() {
        if (!currentUserId) return;
        database.ref('notification').on('value', snapshot => {
            notificationList.innerHTML = '';
            const data = snapshot.val();
            let hasData = false;
            
            // Get hidden notifications from localStorage
            const hiddenNotifs = JSON.parse(localStorage.getItem('hiddenNotifications') || '[]');
            
            if (data) {
                // Convert to array and sort by date descending
                const notifications = Object.keys(data).map(key => ({ id: key, ...data[key] })).reverse();

                notifications.forEach(notif => {
                    // Check if notification is hidden
                    if (hiddenNotifs.includes(notif.id)) return;

                    // Check targeting logic
                    let isTargeted = false;
                    if (notif.userIds && Array.isArray(notif.userIds)) {
                        // If userIds exists, check if current user is in the list
                        if (notif.userIds.includes(currentUserId)) {
                            isTargeted = true;
                        }
                    } else {
                        // If userIds doesn't exist or is null, it's for everyone
                        isTargeted = true;
                    }

                    if (isTargeted) {
                        hasData = true;
                        const title = notif.text || 'Notification';
                        const desc = notif.discrimination || '';
                        const date = notif.date || '';
                        const time = notif.time || '';
                        const image = notif.image || '';
                        
                        // Safe strings for onclick
                        const safeTitle = title.replace(/'/g, "\\'");
                        const safeDesc = desc.replace(/'/g, "\\'");
                        const safeDate = date.replace(/'/g, "\\'");
                        const safeImage = image.replace(/'/g, "\\'");
                        
                        let imageHtml = '';
                        if(image) {
                            imageHtml = `<img src="${image}" class="w-12 h-12 rounded-lg object-cover mr-3">`;
                        }

                        const item = document.createElement('div');
                        item.className = 'notification-item bg-white dark:bg-card-dark p-4 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 flex items-start group cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors mb-3';
                        item.innerHTML = `
                            ${imageHtml}
                            <div class="flex-1 pr-2 overflow-hidden">
                                <div class="flex justify-between items-start mb-1">
                                    <h4 class="font-bold text-slate-800 dark:text-white text-sm line-clamp-1">${title}</h4>
                                    <p class="text-[10px] font-semibold text-slate-400 uppercase tracking-wide whitespace-nowrap ml-2">${date}</p>
                                </div>
                                <p class="text-xs text-slate-500 dark:text-slate-400 line-clamp-2 leading-relaxed">${desc}</p>
                            </div>
                        `;
                        
                        // Swipe Logic
                        let startX;
                        item.addEventListener('touchstart', (e) => {
                            startX = e.touches[0].clientX;
                        });
                        
                        item.addEventListener('touchmove', (e) => {
                            let currentX = e.touches[0].clientX;
                            let diff = currentX - startX;
                            if (Math.abs(diff) < 150) {
                                item.style.transform = `translateX(${diff}px)`;
                            }
                        });
                        
                        item.addEventListener('touchend', (e) => {
                            let endX = e.changedTouches[0].clientX;
                            let diff = endX - startX;
                            
                            if (Math.abs(diff) > 100) { // Threshold for hide
                                // Animate out
                                item.style.transition = 'all 0.3s ease';
                                item.style.transform = diff > 0 ? 'translateX(100%)' : 'translateX(-100%)';
                                item.style.opacity = '0';
                                item.style.height = '0';
                                item.style.margin = '0';
                                item.style.padding = '0';
                                
                                // Hide locally
                                setTimeout(() => {
                                    const currentHidden = JSON.parse(localStorage.getItem('hiddenNotifications') || '[]');
                                    currentHidden.push(notif.id);
                                    localStorage.setItem('hiddenNotifications', JSON.stringify(currentHidden));
                                    item.remove();
                                    
                                    // Check if list is empty
                                    if (notificationList.children.length === 0) {
                                        notificationList.innerHTML = '<p class="text-center text-slate-400 text-sm py-10">No new notifications.</p>';
                                    }
                                }, 300);
                            } else {
                                // Reset
                                item.style.transform = 'translateX(0)';
                            }
                        });

                        item.onclick = () => openNotificationDetails(safeTitle, safeDesc, safeDate, safeImage);
                        notificationList.appendChild(item);
                    }
                });
            }

            if (!hasData) {
                notificationList.innerHTML = '<p class="text-center text-slate-400 text-sm py-10">No new notifications.</p>';
            }
        });
    }

    window.openNotificationDetails = function(title, desc, date, image) {
        document.getElementById('nd-title').textContent = title;
        document.getElementById('nd-desc').textContent = desc;
        document.getElementById('nd-date').textContent = date;
        
        const imgEl = document.getElementById('nd-image');
        if (image && image !== 'undefined' && image !== '') {
            imgEl.src = image;
            imgEl.classList.remove('hidden');
        } else {
            imgEl.classList.add('hidden');
        }
        
        notificationDetailsScreen.classList.add('active');
    }

    // --- Refer Logic ---
    copyCodeBtn.addEventListener('click', () => {
        const codeToCopy = myPromoCodeEl.textContent;
        if (navigator.clipboard) {
            navigator.clipboard.writeText(codeToCopy).then(() => {
                showToast("Promo code copied!");
            }).catch(err => {
                showToast("Copy failed!");
            });
        } else {
            const textArea = document.createElement("textarea");
            textArea.value = codeToCopy;
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showToast("Promo code copied!");
            } catch (err) {
                showToast("Copy failed!");
            }
            document.body.removeChild(textArea);
        }
    });

    // NEW Share function
    function shareReferral(platform) {
        const promoCode = currentUserPromo;
        // Use dynamic link from settings/shareLink
        const url = dynamicShareLink;
        const text = `Hey! Use my referral code ${promoCode} to sign up and get a reward. Join here: ${url}`;
        let shareUrl = '';

        switch(platform) {
            case 'whatsapp':
                shareUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;
                break;
            case 'facebook':
                shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}&quote=${encodeURIComponent(text)}`;
                break;
            case 'telegram':
                shareUrl = `https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`;
                break;
            case 'sms':
                shareUrl = `sms:?&body=${encodeURIComponent(text)}`;
                break;
        }
        
        if (shareUrl) {
            window.open(shareUrl, '_blank');
        }
    }


    function loadReferralStats() {
        if (!currentUserId) return;
        const referralsRef = database.ref('referrals');
        referralsRef.orderByChild('referrerId').equalTo(currentUserId).on('value', snapshot => {
            let totalReferrals = 0;
            let totalEarnings = 0;
            if (snapshot.exists()) {
                snapshot.forEach(childSnapshot => {
                    const referralData = childSnapshot.val();
                    totalReferrals += 1;
                    totalEarnings += referralData.rewards.referrer || 0;
                });
            }
            totalReferralsCountEl.textContent = totalReferrals;
            totalEarningsCountEl.textContent = totalEarnings;
        });
    }

    submitReferBtn.addEventListener('click', async () => {
        const enteredCode = referralInput.value.trim().toUpperCase();
        referMsg.textContent = "";
        referMsg.className = "text-xs text-center mt-3 h-4";

        if (!enteredCode) {
            referMsg.textContent = "Please enter a valid code.";
            referMsg.classList.add('text-red-500');
            return;
        }

        if (enteredCode === currentUserPromo) {
            referMsg.textContent = "You cannot use your own referral code.";
            referMsg.classList.add('text-red-500');
            return;
        }
        
        const currentUserRef = database.ref(`users/${currentUserId}`);
        const currentUserSnap = await currentUserRef.once('value');
        const currentUserData = currentUserSnap.val();
        
        if (currentUserData.hasUsedReferral) {
            referMsg.textContent = "You have already used a referral code.";
            referMsg.classList.add('text-red-500');
            return;
        }

        const usersRef = database.ref('users');
        usersRef.orderByChild('promoCode').equalTo(enteredCode).once('value', snapshot => {
            if (snapshot.exists()) {
                let referrerId;
                let referrerData;
                snapshot.forEach(childSnapshot => {
                    referrerId = childSnapshot.key;
                    referrerData = childSnapshot.val();
                });

                const refereeWalletRef = database.ref(`users/${currentUserId}/balance`);
                refereeWalletRef.transaction(currentBalance => (parseFloat(currentBalance) || 0) + 30);
                
                const referrerWalletRef = database.ref(`users/${referrerId}/balance`);
                referrerWalletRef.transaction(currentBalance => (parseFloat(currentBalance) || 0) + 10);
                
                currentUserRef.update({ hasUsedReferral: true });

                const referralRecordRef = database.ref('referrals').push();
                referralRecordRef.set({
                    referrerId: referrerId,
                    referrerName: referrerData.name,
                    refereeId: currentUserId,
                    refereeName: currentUserData.name,
                    promoCodeUsed: enteredCode,
                    date: new Date().toISOString(),
                    rewards: {
                        referrer: 10,
                        referee: 30
                    }
                });
                
                referMsg.textContent = "Success! ₹30 added to your wallet.";
                referMsg.classList.add('text-green-500', 'font-bold');
                referralInput.value = '';
                showToast("Referral Reward Claimed!");

            } else {
                referMsg.textContent = "Invalid referral code.";
                referMsg.classList.add('text-red-500');
            }
        });
    });

    // --- Withdrawal Logic (NEW) ---
    
    // Open Withdrawal Screen
    openWithdrawBtn.addEventListener('click', () => {
        withdrawalScreen.classList.add('active');
        hideHeader();
    });
    
    backWithdrawBtn.addEventListener('click', () => {
        withdrawalScreen.classList.remove('active');
        // Do not show header because we are returning to Profile tab which has no header
    });
    
    // Open Add Bank Dialog
    bankBox.addEventListener('click', () => {
        addBankDialog.classList.add('show');
    });
    
    // Save Bank Details
    saveBankBtn.addEventListener('click', () => {
        const bankName = document.getElementById('bank-name-select').value;
        const accNo = document.getElementById('bank-acc-no').value.trim();
        const ifsc = document.getElementById('bank-ifsc').value.trim().toUpperCase();
        const holder = document.getElementById('bank-holder').value.trim();
        
        if(!bankName || !accNo || !ifsc || !holder) {
            alert("Please fill all bank details.");
            return;
        }
        
        const bankData = {
            bankName: bankName,
            accountNumber: accNo,
            ifsc: ifsc,
            holderName: holder
        };
        
        database.ref(`users/${currentUserId}/bank`).set(bankData).then(() => {
            showToast("Bank Added Successfully!");
            addBankDialog.classList.remove('show');
        });
    });
    
    // Amount Chips
    amountChips.forEach(chip => {
        chip.addEventListener('click', () => {
            withdrawAmountInput.value = chip.textContent;
        });
    });
    
    // Final Withdraw Action
    finalWithdrawBtn.addEventListener('click', () => {
        const amount = parseFloat(withdrawAmountInput.value);
        const currentBal = parseFloat(withdrawBalanceEl.textContent);
        
        if(!currentBankData) {
            alert("Please add a bank account first.");
            return;
        }
        
        if(!amount || amount <= 0) {
            alert("Please enter a valid amount.");
            return;
        }
        
        if(amount > currentBal) {
            alert("Insufficient balance!");
            return;
        }
        
        // Atomic Transaction: Deduct balance and add to withdraw history
        const userRef = database.ref(`users/${currentUserId}/balance`);
        
        userRef.transaction(currentBalance => {
            if (currentBalance >= amount) {
                return currentBalance - amount;
            } else {
                return; // Abort if balance changed and is now insufficient
            }
        }, (error, committed, snapshot) => {
            if (error) {
                alert("Withdrawal failed.");
            } else if (!committed) {
                alert("Insufficient balance (transaction aborted).");
            } else {
                // Success - Save to withdraw folder
                database.ref('withdraw').push({
                    userid: currentUserId,
                    amount: amount,
                    bankDetails: currentBankData,
                    status: 'Pending',
                    date: new Date().toISOString()
                }).then(() => {
                    showToast("Withdrawal Request Sent!");
                    withdrawAmountInput.value = '';
                });
            }
        });
    });
    
    // --- Withdrawal History Logic ---
    
    openWithdrawHistoryBtn.addEventListener('click', () => {
        withdrawalHistoryScreen.classList.add('active');
        loadWithdrawalHistory(7); // Default 7 days
    });
    
    backWithdrawHistoryBtn.addEventListener('click', () => {
        withdrawalHistoryScreen.classList.remove('active');
    });
    
    // Tab Filtering
    historyTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            historyTabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            const days = parseInt(tab.getAttribute('data-filter'));
            loadWithdrawalHistory(days);
        });
    });
    
    function loadWithdrawalHistory(days) {
        const cutoffTime = Date.now() - (days * 24 * 60 * 60 * 1000);
        withdrawalList.innerHTML = '<p class="text-center text-slate-400 text-sm py-10">Loading...</p>';
        
        database.ref('withdraw').orderByChild('userid').equalTo(currentUserId).once('value', snapshot => {
            withdrawalList.innerHTML = '';
            const data = snapshot.val();
            let hasData = false;
            
            if(data) {
                // Convert to array and sort descending by date
                const entries = Object.values(data).sort((a,b) => new Date(b.date) - new Date(a.date));
                
                entries.forEach(entry => {
                    const entryTime = new Date(entry.date).getTime();
                    
                    if(entryTime >= cutoffTime) {
                        hasData = true;
                        const dateStr = new Date(entry.date).toLocaleDateString();
                        const accLast4 = entry.bankDetails.accountNumber.slice(-4);
                        
                        let statusColor = 'text-yellow-500';
                        if(entry.status === 'Success') statusColor = 'text-green-500';
                        if(entry.status === 'Rejected') statusColor = 'text-red-500';
                        
                        withdrawalList.innerHTML += `
                            <div class="bg-white dark:bg-card-dark p-4 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 flex justify-between items-center">
                                <div>
                                    <p class="font-bold text-slate-800 dark:text-white">Withdrawal</p>
                                    <p class="text-xs text-slate-400 mt-1">${dateStr} • Acc: **${accLast4}</p>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold text-slate-900 dark:text-white">- ₹${entry.amount}</p>
                                    <p class="text-xs font-semibold ${statusColor} mt-1">${entry.status}</p>
                                </div>
                            </div>
                        `;
                    }
                });
            }
            
            if(!hasData) {
                withdrawalList.innerHTML = '<p class="text-center text-slate-400 text-sm py-10">No history found for this period.</p>';
            }
        });
    }

    // --- Work & Advance Process Logic ---
    
    // MODIFIED: This now opens the new Labour Work Dialog
    window.openWorkPinDialog = function(key, name, amount) {
        selectedLabourKey = key;
        selectedLabourName = name;
        baseLabourAmount = amount; // Store the original full day amount
        
        // Reset and show the new dialog
        labourWorkTypeDropdown.value = 'full';
        labourCustomAmountContainer.classList.add('hidden');
        labourCustomAmountInput.value = '';
        labourWorkDialog.classList.add('show');
    }

    labourWorkTypeDropdown.addEventListener('change', function() {
        if (this.value === 'custom') {
            labourCustomAmountContainer.classList.remove('hidden');
        } else {
            labourCustomAmountContainer.classList.add('hidden');
        }
    });

    saveLabourWorkBtn.addEventListener('click', () => {
        const workType = labourWorkTypeDropdown.value;
        let finalAmount = 0;

        if (workType === 'full') {
            finalAmount = parseFloat(baseLabourAmount);
        } else if (workType === 'half') {
            finalAmount = parseFloat(baseLabourAmount) / 2;
        } else if (workType === 'custom') {
            const customValue = parseFloat(labourCustomAmountInput.value);
            if (!customValue || customValue <= 0) {
                 alert("Please enter a valid custom amount.");
                 return;
            }
            finalAmount = customValue;
        }

        selectedLabourAmount = finalAmount; // Set the final calculated amount
        currentActionType = 'work';
        
        labourWorkDialog.classList.remove('show');
        workMpinInput.value = '';
        workPinDialogOverlay.classList.add('show');
    });


    // Open No Work PIN Dialog - Unchanged
    window.openNoWorkPinDialog = function(key, name) {
        selectedLabourKey = key;
        selectedLabourName = name;
        currentActionType = 'nowork';
        workMpinInput.value = '';
        workPinDialogOverlay.classList.add('show');
    }

    // Open Advance Dialog - Unchanged
    window.openAdvanceDialog = function(key, name) {
        selectedLabourKey = key;
        selectedLabourName = name;
        advanceAmountInput.value = '';
        advanceDialogOverlay.classList.add('show');
    }

    // Handle Advance Save -> Open MPIN
    saveAdvanceBtn.addEventListener('click', () => {
        const amount = advanceAmountInput.value.trim();
        if(!amount) {
            alert("Please enter amount");
            return;
        }
        tempAdvanceAmount = amount;
        
        if (currentActionType === 'room_advance_init') {
            currentActionType = 'room_advance';
        } else {
            currentActionType = 'advance'; // Default labour
        }
        
        advanceDialogOverlay.classList.remove('show');
        workMpinInput.value = '';
        workPinDialogOverlay.classList.add('show');
    });

    // Open Create MPIN Dialog
    window.openCreateMpinDialog = function() {
        workPinDialogOverlay.classList.remove('show');
        verifyMobileInput.value = '';
        newMpinInput.value = '';
        createMpinDialogOverlay.classList.add('show');
    }

    // Update MPIN Logic
    updateMpinBtn.addEventListener('click', () => {
        const mobile = verifyMobileInput.value.trim();
        const pin = newMpinInput.value.trim();

        if(!mobile || pin.length !== 4) {
            alert("Please enter valid mobile and 4 digit PIN");
            return;
        }

        database.ref('users/' + currentUserId).once('value').then(snapshot => {
            const userData = snapshot.val();
            if(userData && userData.mobile === mobile) {
                database.ref('users/' + currentUserId).update({ mpin: pin }).then(() => {
                    showToast("MPIN Updated Successfully!");
                    createMpinDialogOverlay.classList.remove('show');
                });
            } else {
                alert("Mobile number does not match!");
            }
        });
    });

    // Submit Work/Advance Logic (MPIN Verification)
    submitWorkBtn.addEventListener('click', () => {
        const pin = workMpinInput.value.trim();
        if(pin.length !== 4) {
            alert("Enter 4 digit PIN");
            return;
        }

        database.ref('users/' + currentUserId + '/mpin').once('value').then(snapshot => {
            const savedMpin = snapshot.val();
            if(savedMpin === pin) {
                // MPIN Matched
                const dateObj = new Date();
                const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'long' });

                if (currentActionType === 'work') {
                    // Save Work
                    const newWorkRef = database.ref('addwork').push();
                    newWorkRef.set({
                        name: selectedLabourName,
                        amount: selectedLabourAmount,
                        date: dateObj.toLocaleDateString(),
                        userid: currentUserId,
                        timestamp: Date.now()
                    }).then(() => {
                        showToast("Work Added Successfully!");
                        workPinDialogOverlay.classList.remove('show');
                    });
                } else if (currentActionType === 'advance') {
                    // Save Advance
                    const newAdvanceRef = database.ref('addwork').push();
                    newAdvanceRef.set({
                        name: selectedLabourName,
                        advance: tempAdvanceAmount,
                        date: dateObj.toLocaleDateString(),
                        userid: currentUserId,
                        timestamp: Date.now()
                    }).then(() => {
                        showToast("Advance Added Successfully!");
                        workPinDialogOverlay.classList.remove('show');
                    });
                } else if (currentActionType === 'nowork') {
                    // Save No Work
                    const newNoWorkRef = database.ref('addwork').push();
                    newNoWorkRef.set({
                        name: selectedLabourName,
                        date: dateObj.toLocaleDateString(),
                        day: dayName,
                        status: "no",
                        userid: currentUserId,
                        timestamp: Date.now()
                    }).then(() => {
                        showToast("No Work Status Updated!");
                        workPinDialogOverlay.classList.remove('show');
                    });
                } else if (currentActionType === 'clear_work') {
                    if(currentLabourViewKey) {
                        database.ref(`users/${currentUserId}/labour/${currentLabourViewKey}`).update({
                            lastClearedWork: Date.now()
                        }).then(() => {
                            showToast("Work Amount Cleared!");
                            workPinDialogOverlay.classList.remove('show');
                            loadWorkHistory(currentLabourViewName);
                        });
                    }
                } else if (currentActionType === 'conductor_work') {
                    const newWorkRef = database.ref('cwork').push();
                    newWorkRef.set({
                        name: currentConductorName,
                        amount: tempAdvanceAmount, 
                        labour: selectedWorkplace,
                        date: dateObj.toLocaleDateString(),
                        day: dayName,
                        userid: currentUserId,
                        timestamp: Date.now()
                    }).then(() => {
                        showToast("Conductor Work Added!");
                        workPinDialogOverlay.classList.remove('show');
                    });
                } else if (currentActionType === 'room_payment') {
                     // Save Room Payment
                     const newRoomRef = database.ref('roombill').push();
                     newRoomRef.set({
                         name: currentRoomName,
                         amount: currentRoomAmount, 
                         date: dateObj.toLocaleDateString(),
                         day: dayName,
                         userid: currentUserId,
                         timestamp: Date.now()
                     }).then(() => {
                         showToast("Room Payment Added!");
                         workPinDialogOverlay.classList.remove('show');
                     });
                } else if (currentActionType === 'room_advance') {
                    // Save Room Advance
                    const newRoomRef = database.ref('roombill').push();
                    newRoomRef.set({
                        name: currentRoomName,
                        advance: tempAdvanceAmount, 
                        date: dateObj.toLocaleDateString(),
                        day: dayName,
                        userid: currentUserId,
                        timestamp: Date.now()
                    }).then(() => {
                        showToast("Room Advance Added!");
                        workPinDialogOverlay.classList.remove('show');
                    });
                }
            } else {
                alert("Wrong MPIN!");
            }
        });
    });

    // --- Conductor Work Logic ---
    
    window.openConductorWorkDialog = function(key, name, amount) {
        currentConductorKey = key;
        currentConductorName = name;
        currentConductorBaseAmount = amount; 
        
        conductorTripCount.value = '1'; 
        selectedWorkplace = null;
        workplaceInput.value = '';
        workTypeDropdown.value = 'full';
        customAmountContainer.classList.add('hidden');
        conductorCustomAmount.value = '';
        
        conductorWorkDialog.classList.add('show');
    }

    workTypeDropdown.addEventListener('change', function() {
        if (this.value === 'custom') {
            customAmountContainer.classList.remove('hidden');
        } else {
            customAmountContainer.classList.add('hidden');
        }
    });

    window.openAddWorkplaceDialog = function() {
        conductorWorkDialog.classList.remove('show');
        newWorkplaceName.value = '';
        addWorkplaceDialog.classList.add('show');
    }

    window.saveWorkplace = function() {
        const name = newWorkplaceName.value.trim();
        if(!name) {
            alert("Enter workplace name");
            return;
        }
        database.ref('workplace').push({
            name: name,
            userid: currentUserId
        }).then(() => {
            showToast("Workplace Added!");
            addWorkplaceDialog.classList.remove('show');
            conductorWorkDialog.classList.add('show');
        });
    }

    window.openSelectWorkplaceScreen = function() {
        conductorWorkDialog.classList.remove('show');
        selectWorkplaceScreen.classList.add('active');
        renderWorkplaceList();
    }

    function renderWorkplaceList() {
        const list = document.getElementById('workplace-list');
        list.innerHTML = '<p class="text-center text-slate-400 text-sm py-10">Loading...</p>';
        
        database.ref('workplace').orderByChild('userid').equalTo(currentUserId).once('value', snapshot => {
            list.innerHTML = '';
            const data = snapshot.val();
            if(data) {
                Object.keys(data).forEach(key => {
                    const item = document.createElement('div');
                    item.className = 'p-4 border-b border-slate-100 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 cursor-pointer';
                    item.textContent = data[key].name;
                    item.onclick = () => selectWorkplace(data[key].name);
                    list.appendChild(item);
                });
            } else {
                list.innerHTML = '<p class="text-center text-slate-400 text-sm py-10">No workplaces found.</p>';
            }
        });
    }

    function selectWorkplace(name) {
        selectedWorkplace = name;
        workplaceInput.value = name;
        selectWorkplaceScreen.classList.remove('active');
        conductorWorkDialog.classList.add('show');
    }

    saveConductorWorkBtn.addEventListener('click', () => {
        const count = parseFloat(conductorTripCount.value);
        const workType = workTypeDropdown.value;
        let singleTripAmount = 0;

        if (workType === 'full') {
            singleTripAmount = parseFloat(currentConductorBaseAmount);
        } else if (workType === 'half') {
            singleTripAmount = parseFloat(currentConductorBaseAmount) / 2;
        } else if (workType === 'custom') {
            const customValue = parseFloat(conductorCustomAmount.value);
            if (!customValue || customValue <= 0) {
                 alert("Please enter a valid custom amount.");
                 return;
            }
            singleTripAmount = customValue;
        }
        
        const totalAmount = count * singleTripAmount;
        tempAdvanceAmount = totalAmount;

        if(!count || !selectedWorkplace) {
            alert("Please enter trip count and select a workplace.");
            return;
        }

        currentActionType = 'conductor_work';
        conductorWorkDialog.classList.remove('show');
        workMpinInput.value = '';
        workPinDialogOverlay.classList.add('show');
    });

    // --- Labour View Logic ---
    window.openLabourView = function(key, name, mobile, address, amount) {
        document.getElementById('lv-name').textContent = name;
        document.getElementById('lv-mobile').textContent = mobile;
        document.getElementById('lv-address').textContent = address;
        currentLabourViewName = name;
        currentLabourViewKey = key;
        currentLabourViewMobile = mobile;
        
        labourViewScreen.classList.add('active');
        hideHeader();
        loadWorkHistory(name);
    }
    
    // --- NEW: Conductor View Logic ---
    window.openConductorHistory = function(key, name, mobile, address) {
        document.getElementById('ch-name').textContent = name;
        document.getElementById('ch-mobile').textContent = mobile;
        document.getElementById('ch-address').textContent = address;
        
        currentConductorViewName = name;
        currentConductorViewMobile = mobile;
        currentConductorKey = key;
        
        conductorHistoryScreen.classList.add('active');
        hideHeader();
        
        loadConductorHistory(name);
    }
    
    // Date Utility for Weekly Filter
    function getWeekRange() {
        const today = new Date();
        const currentDay = today.getDay(); // 0 (Sun) - 6 (Sat)
        
        const start = new Date(today);
        start.setDate(today.getDate() - currentDay);
        start.setHours(0,0,0,0);
        
        const end = new Date(start);
        end.setDate(start.getDate() + 6);
        end.setHours(23,59,59,999);
        
        return { start, end };
    }

    function loadWorkHistory(labourName) {
        const listContainer = document.getElementById('lv-work-list');
        const totalWorkEl = document.getElementById('lv-total-work');
        const totalAdvanceEl = document.getElementById('lv-total-advance');
        const subtotalEl = document.getElementById('lv-subtotal');
        
        listContainer.innerHTML = '<p class="text-center text-slate-400 text-sm py-10">Loading history...</p>';
        totalWorkEl.textContent = '0';
        totalAdvanceEl.textContent = '0';
        subtotalEl.textContent = '0';
        
        const { start, end } = getWeekRange();
        currentWeeklyData = [];

        database.ref(`users/${currentUserId}/labour/${currentLabourViewKey}`).once('value', labourSnap => {
            const labourData = labourSnap.val() || {};
            const lastClearedWork = labourData.lastClearedWork || 0;
            const lastClearedAdvance = labourData.lastClearedAdvance || 0;

            database.ref('addwork').orderByChild('userid').equalTo(currentUserId).on('value', snapshot => {
                listContainer.innerHTML = '';
                const data = snapshot.val();
                let hasData = false;
                let totalWork = 0;
                let totalAdvance = 0;

                if (data) {
                    Object.keys(data).forEach(key => {
                        const work = data[key];
                        if (work.name === labourName) {
                            const workDate = new Date(work.date);
                            const workTimestamp = work.timestamp || workDate.getTime(); 

                            // Filter logic: Must be in Current Week (Sun-Sat)
                            if (workDate >= start && workDate <= end) {
                                hasData = true;
                                currentWeeklyData.push(work);
                                
                                // Calculate totals only if not cleared and within range
                                if(work.amount && workTimestamp > lastClearedWork) {
                                    totalWork += parseFloat(work.amount) || 0;
                                }
                                if(work.advance && workTimestamp > lastClearedAdvance) {
                                    totalAdvance += parseFloat(work.advance) || 0;
                                }

                                const dateStr = workDate.toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' });
                                const dayStr = workDate.toLocaleDateString('en-US', { weekday: 'long' });

                                let itemHtml = '';
                                let amountHtml = '';
                                
                                if (work.amount) {
                                    amountHtml = `<div class="text-right"><p class="text-sm font-bold text-green-600 dark:text-green-400">+ ₹${work.amount}</p><p class="text-[10px] text-slate-400 dark:text-slate-500 uppercase tracking-wide">Work</p></div>`;
                                } else if (work.advance) {
                                    amountHtml = `<div class="text-right"><p class="text-sm font-bold text-orange-600 dark:text-orange-400">- ₹${work.advance}</p><p class="text-[10px] text-slate-400 dark:text-slate-500 uppercase tracking-wide">Advance</p></div>`;
                                } else if (work.status === 'no') {
                                    amountHtml = `<div class="text-right"><span class="material-symbols-outlined text-red-500 text-lg">close</span><p class="text-[10px] text-slate-400 dark:text-slate-500 uppercase tracking-wide">No Work</p></div>`;
                                }

                                itemHtml = `<div onclick="openDeleteWorkItemDialog('${key}')" class="cursor-pointer flex justify-between items-center py-3 px-4 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors ${work.advance ? 'border-l-4 border-orange-500' : (work.status === 'no' ? 'border-l-4 border-red-500' : '')}"><div><p class="text-sm font-medium text-slate-800 dark:text-white">${dateStr}</p><p class="text-xs text-slate-400 dark:text-slate-500">${dayStr}</p></div>${amountHtml}</div>`;
                                listContainer.innerHTML += itemHtml;
                            }
                        }
                    });
                }
                
                totalWorkEl.textContent = totalWork;
                totalAdvanceEl.textContent = totalAdvance;
                subtotalEl.textContent = totalWork - totalAdvance;
                
                if (!hasData) {
                    listContainer.innerHTML = '<p class="text-center text-slate-400 text-sm py-10">No history for this week.</p>';
                }
            });
        });
    }

    // NEW: Load Conductor History function
    function loadConductorHistory(conductorName) {
        const listContainer = document.getElementById('ch-work-list');
        const totalWorkEl = document.getElementById('ch-total-work');
        const totalAdvanceEl = document.getElementById('ch-total-advance');
        const subtotalEl = document.getElementById('ch-subtotal');
        
        listContainer.innerHTML = '<p class="text-center text-slate-400 text-sm py-10">Loading history...</p>';
        totalWorkEl.textContent = '0';
        totalAdvanceEl.textContent = '0';
        subtotalEl.textContent = '0';
        
        const { start, end } = getWeekRange();
        currentConductorWeeklyData = [];

        database.ref('cwork').orderByChild('userid').equalTo(currentUserId).on('value', snapshot => {
            listContainer.innerHTML = '';
            const data = snapshot.val();
            let hasData = false;
            let totalWork = 0;
            let totalAdvance = 0;

            if (data) {
                Object.keys(data).forEach(key => {
                    const work = data[key];
                    if (work.name === conductorName) {
                        const workDate = new Date(work.date);
                        if (workDate >= start && workDate <= end) {
                            if (work.amount) {
                                totalWork += parseFloat(work.amount) || 0;
                            }
                            if (work.advance) {
                                totalAdvance += parseFloat(work.advance) || 0;
                            }

                            hasData = true;
                            currentConductorWeeklyData.push(work);
                            
                            const dateStr = workDate.toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' });
                            const dayStr = workDate.toLocaleDateString('en-US', { weekday: 'long' });

                            let amountHtml = '';
                            if (work.amount) {
                                amountHtml = `<div class="text-right">
                                    <p class="text-sm font-bold text-green-600 dark:text-green-400">+ ₹${work.amount}</p>
                                    <p class="text-[10px] text-slate-400 dark:text-slate-500 uppercase tracking-wide">${work.labour || 'Work'}</p>
                                </div>`;
                            } else if (work.advance) {
                                amountHtml = `<div class="text-right">
                                    <p class="text-sm font-bold text-orange-600 dark:text-orange-400">- ₹${work.advance}</p>
                                    <p class="text-[10px] text-slate-400 dark:text-slate-500 uppercase tracking-wide">Advance</p>
                                </div>`;
                            }

                            listContainer.innerHTML += `<div class="flex justify-between items-center py-3 px-4 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                                <div>
                                    <p class="text-sm font-medium text-slate-800 dark:text-white">${dateStr}</p>
                                    <p class="text-xs text-slate-400 dark:text-slate-500">${dayStr}</p>
                                </div>
                                ${amountHtml}
                            </div>`;
                        }
                    }
                });
            }
            
            totalWorkEl.textContent = totalWork;
            totalAdvanceEl.textContent = totalAdvance;
            subtotalEl.textContent = totalWork - totalAdvance;
            
            if (!hasData) {
                listContainer.innerHTML = '<p class="text-center text-slate-400 text-sm py-10">No history for this week.</p>';
            }
        });
    }

    
    // --- Share Functionality ---
    window.shareWeeklyReport = function() {
        if (!currentLabourViewMobile) {
            alert("Labour mobile number not found!");
            return;
        }
        const { start, end } = getWeekRange();
        const startDate = start.toLocaleDateString('en-US', { day: 'numeric', month: 'short' });
        const endDate = end.toLocaleDateString('en-US', { day: 'numeric', month: 'short' });
        
        let message = `*Labour Report: ${currentLabourViewName}*\n`;
        message += `Week: ${startDate} - ${endDate}\n`;
        message += `------------------------\n`;
        
        if (currentWeeklyData.length === 0) {
            message += "No work history for this week.\n";
        } else {
            currentWeeklyData.sort((a, b) => new Date(a.date) - new Date(b.date));
            currentWeeklyData.forEach(work => {
                const dateStr = new Date(work.date).toLocaleDateString('en-US', { day: 'numeric', month: 'short' });
                if (work.amount) message += `${dateStr}: Work (+₹${work.amount})\n`;
                else if (work.advance) message += `${dateStr}: Advance (-₹${work.advance})\n`;
                else if (work.status === 'no') message += `${dateStr}: No Work (X)\n`;
            });
        }
        
        const totalWork = document.getElementById('lv-total-work').textContent;
        const totalAdvance = document.getElementById('lv-total-advance').textContent;
        const subtotal = document.getElementById('lv-subtotal').textContent;
        
        message += `------------------------\nTotal Work: ₹${totalWork}\nTotal Advance: ₹${totalAdvance}\n*Subtotal: ₹${subtotal}*\n`;
        
        let phone = currentLabourViewMobile.replace(/\s+/g, '').replace(/-/g, '');
        if (!phone.startsWith('+')) phone = '91' + phone;
        
        window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank');
    }
    
    // NEW: Share Conductor Report
    window.shareConductorReport = function() {
        if (!currentConductorViewMobile) {
            alert("Conductor mobile number not found!");
            return;
        }
        const { start, end } = getWeekRange();
        const startDate = start.toLocaleDateString('en-US', { day: 'numeric', month: 'short' });
        const endDate = end.toLocaleDateString('en-US', { day: 'numeric', month: 'short' });
        
        let message = `*Conductor Report: ${currentConductorViewName}*\n`;
        message += `Week: ${startDate} - ${endDate}\n`;
        message += `------------------------\n`;
        
        if (currentConductorWeeklyData.length === 0) {
            message += "No history for this week.\n";
        } else {
            currentConductorWeeklyData.sort((a, b) => new Date(a.date) - new Date(b.date));
            currentConductorWeeklyData.forEach(work => {
                const dateStr = new Date(work.date).toLocaleDateString('en-US', { day: 'numeric', month: 'short' });
                if (work.amount) message += `${dateStr}: Work at ${work.labour} (+₹${work.amount})\n`;
                else if (work.advance) message += `${dateStr}: Advance (-₹${work.advance})\n`;
            });
        }
        
        const totalWork = document.getElementById('ch-total-work').textContent;
        const totalAdvance = document.getElementById('ch-total-advance').textContent;
        const subtotal = document.getElementById('ch-subtotal').textContent;
        
        message += `------------------------\nTotal Amount: ₹${totalWork}\nTotal Advance: ₹${totalAdvance}\n*Subtotal: ₹${subtotal}*\n`;
        
        let phone = currentConductorViewMobile.replace(/\s+/g, '').replace(/-/g, '');
        if (!phone.startsWith('+')) phone = '91' + phone;
        
        window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank');
    }
    
    // --- View All Screen Logic ---
    window.openViewAllScreen = function() {
        viewAllHistoryScreen.classList.add('active');
        currentHistoryContext = 'labour';
        loadAllWorkHistory(currentLabourViewName);
    }
    
    // NEW: View all for Conductor
    window.openConductorViewAll = function() {
        viewAllHistoryScreen.classList.add('active');
        currentHistoryContext = 'conductor';
        const listContainer = document.getElementById('all-history-list');
        listContainer.innerHTML = '<p class="text-center text-slate-400 text-sm py-10">Loading...</p>';
        document.getElementById('all-history-stats').innerHTML = ''; // Clear stats for conductor view (or implement separately)
        
        database.ref('cwork').orderByChild('userid').equalTo(currentUserId).once('value', snapshot => {
            listContainer.innerHTML = '';
            const data = snapshot.val();
            let hasData = false;
            if(data) {
                Object.keys(data).forEach(key => {
                    const entry = data[key];
                    if(entry.name === currentConductorViewName) {
                        hasData = true;
                        const dateStr = new Date(entry.date).toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' });
                        let amountHtml = '';
                        if(entry.amount) amountHtml = `<span class="border border-green-500 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 text-xs font-bold px-2 py-1 rounded">+ ₹${entry.amount}</span>`;
                        else if(entry.advance) amountHtml = `<span class="border border-orange-500 bg-orange-50 dark:bg-orange-900/20 text-orange-700 dark:text-orange-400 text-xs font-bold px-2 py-1 rounded">- ₹${entry.advance}</span>`;
                        
                        const item = document.createElement('div');
                        item.className = 'flex justify-between items-center py-2 px-2 w-full border-b border-slate-100 dark:border-slate-700 select-none';
                        item.setAttribute('data-key', key);
                        item.innerHTML = `
                            <div>
                                <p class="text-sm font-medium text-slate-800 dark:text-white">${dateStr}</p>
                                <p class="text-[10px] text-slate-400 dark:text-slate-500">${entry.labour || 'Work'}</p>
                            </div>
                            ${amountHtml}
                        `;
                        
                        // Add Long Press Logic
                        addLongPressListener(item, key);
                        listContainer.appendChild(item);
                    }
                });
            }
            if (!hasData) listContainer.innerHTML = '<p class="text-center text-slate-400 text-sm py-10">No history found.</p>';
        });
    }

    // --- MODIFIED: Load All History with Stats and Styling ---
    function loadAllWorkHistory(labourName) {
        const listContainer = document.getElementById('all-history-list');
        const statsContainer = document.getElementById('all-history-stats');
        
        listContainer.innerHTML = '<p class="text-center text-slate-400 text-sm py-10">Loading all history...</p>';
        statsContainer.innerHTML = ''; // Clear stats
        
        let totalWork = 0;
        let totalAdvance = 0;
        
        database.ref('addwork').orderByChild('userid').equalTo(currentUserId).once('value', snapshot => {
            listContainer.innerHTML = '';
            const data = snapshot.val();
            let hasData = false;
            
            if (data) {
                Object.keys(data).forEach(key => {
                    const work = data[key];
                    if (work.name === labourName) {
                        hasData = true;
                        
                        // Accumulate Totals
                        if(work.amount) totalWork += parseFloat(work.amount) || 0;
                        if(work.advance) totalAdvance += parseFloat(work.advance) || 0;
                        
                        const workDate = new Date(work.date);
                        const dateStr = workDate.toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' });
                        const dayStr = workDate.toLocaleDateString('en-US', { weekday: 'long' });
                        let amountHtml = '';
                        
                        // Styled Amount Boxes
                        if (work.amount) {
                             amountHtml = `<span class="border border-green-500 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 text-xs font-bold px-2 py-1 rounded">+ ₹${work.amount}</span>`;
                        } else if (work.advance) {
                             amountHtml = `<span class="border border-orange-500 bg-orange-50 dark:bg-orange-900/20 text-orange-700 dark:text-orange-400 text-xs font-bold px-2 py-1 rounded">- ₹${work.advance}</span>`;
                        } else if (work.status === 'no') {
                             amountHtml = `<span class="border border-red-500 bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-400 text-xs font-bold px-2 py-1 rounded">ABSENT</span>`;
                        }

                        const item = document.createElement('div');
                        item.className = 'flex justify-between items-center py-2 px-2 w-full border-b border-slate-100 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 select-none';
                        item.setAttribute('data-key', key);
                        item.innerHTML = `
                            <div>
                                <p class="text-sm font-medium text-slate-800 dark:text-white">${dateStr}</p>
                                <p class="text-[10px] text-slate-400 dark:text-slate-500">${dayStr}</p>
                            </div>
                            ${amountHtml}
                        `;
                        
                        // Add Long Press Listener
                        addLongPressListener(item, key);
                        listContainer.appendChild(item);
                    }
                });
            }
            
            // Populate Summary Header
            const subtotal = totalWork - totalAdvance;
            statsContainer.innerHTML = `
                <div class="border border-green-500/30 bg-green-50 dark:bg-green-900/10 rounded-lg p-2 text-center">
                    <p class="text-[8px] text-green-600 dark:text-green-400 font-bold uppercase">Total Work</p>
                    <h3 class="text-xs font-bold text-green-700 dark:text-green-300">₹${totalWork}</h3>
                </div>
                <div class="border border-orange-500/30 bg-orange-50 dark:bg-orange-900/10 rounded-lg p-2 text-center">
                    <p class="text-[8px] text-orange-600 dark:text-orange-400 font-bold uppercase">Total Advance</p>
                    <h3 class="text-xs font-bold text-orange-700 dark:text-orange-300">₹${totalAdvance}</h3>
                </div>
                <div class="border border-blue-500/30 bg-blue-50 dark:bg-blue-900/10 rounded-lg p-2 text-center">
                    <p class="text-[8px] text-blue-600 dark:text-blue-400 font-bold uppercase">Subtotal</p>
                    <h3 class="text-xs font-bold text-blue-700 dark:text-blue-300">₹${subtotal}</h3>
                </div>
            `;
            
            if (!hasData) listContainer.innerHTML = '<p class="text-center text-slate-400 text-sm py-10">No history found.</p>';
        });
    }

    // --- Delete Work Item Logic ---
    window.openDeleteWorkItemDialog = function(key) {
        deleteWorkItemKey = key;
        deleteWorkItemDialog.classList.add('show');
    }

    btnDeleteWorkConfirm.addEventListener('click', () => {
        if(deleteWorkItemKey) {
            database.ref('addwork/' + deleteWorkItemKey).remove().then(() => {
                showToast("Entry Deleted!");
                deleteWorkItemDialog.classList.remove('show');
            });
        }
    });

    // --- Clear Total Logic (UPDATED) ---
    window.openClearOptionsDialog = function() {
        document.getElementById('clear-selection-dialog').classList.add('show');
    }

    window.performClear = function(type) {
        if(!currentLabourViewKey) return;
        
        const updates = {};
        if (type === 'work') {
            updates[`users/${currentUserId}/labour/${currentLabourViewKey}/lastClearedWork`] = Date.now();
        } else if (type === 'advance') {
            updates[`users/${currentUserId}/labour/${currentLabourViewKey}/lastClearedAdvance`] = Date.now();
        }
        
        database.ref().update(updates).then(() => {
            showToast(type === 'work' ? "Total Work Cleared!" : "Total Advance Cleared!");
            document.getElementById('clear-selection-dialog').classList.remove('show');
            loadWorkHistory(currentLabourViewName); // Refresh view
        });
    }

    // --- Clear Total Logic (Old - kept for compatibility if needed, but replaced by new dialog) ---
    window.openClearTotalDialog = function() {
        // Redirect to new dialog
        openClearOptionsDialog();
    }

    // --- Clear Advance Logic ---
    window.openClearAdvanceDialog = function() {
        clearAdvanceDialog.classList.add('show');
    }

    btnClearAdvanceConfirm.addEventListener('click', () => {
        if(!currentLabourViewName) return;
        database.ref('addwork').orderByChild('userid').equalTo(currentUserId).once('value', snapshot => {
            const data = snapshot.val();
            if(data) {
                const updates = {};
                Object.keys(data).forEach(key => {
                    if(data[key].name === currentLabourViewName && data[key].advance) updates[key] = null;
                });
                database.ref('addwork').update(updates).then(() => {
                    showToast("All Advance Cleared!");
                    clearAdvanceDialog.classList.remove('show');
                });
            }
        });
    });
    
    // --- Clear Conductor Logic ---
    window.openClearConductorTotalDialog = function() {
        clearConductorTotalDialog.classList.add('show');
    }
    
    btnClearConductorTotalConfirm.addEventListener('click', () => {
         if(!currentConductorName) return;
         database.ref('cwork').orderByChild('userid').equalTo(currentUserId).once('value', snapshot => {
            const data = snapshot.val();
            if(data) {
                const updates = {};
                Object.keys(data).forEach(key => {
                    if(data[key].name === currentConductorName) updates[key] = null;
                });
                database.ref('cwork').update(updates).then(() => {
                    showToast("Conductor History Cleared!");
                    clearConductorTotalDialog.classList.remove('show');
                });
            }
        });
    });

    // --- Delete Labour Logic ---
    window.openDeleteLabourDialog = function(key) {
        deleteLabourKey = key;
        deleteLabourDialog.classList.add('show');
    }
    
    btnDeleteConfirm.addEventListener('click', () => {
        if(deleteLabourKey && currentUserId) {
            database.ref('labour/' + deleteLabourKey).remove()
            .then(() => {
                showToast("Labour Deleted Successfully!");
                deleteLabourDialog.classList.remove('show');
                deleteLabourKey = null;
            })
            .catch(error => {
                alert("Error deleting: " + error.message);
            });
        }
    });

    // --- Delete Conductor Logic (NEW) ---
    window.openDeleteConductorDialog = function(key) {
        deleteConductorKey = key;
        deleteConductorDialog.classList.add('show');
    }

    btnDeleteConductorConfirm.addEventListener('click', () => {
        if(deleteConductorKey && currentUserId) {
            database.ref('conductor/' + deleteConductorKey).remove()
            .then(() => {
                showToast("Conductor Deleted Successfully!");
                deleteConductorDialog.classList.remove('show');
                deleteConductorKey = null;
            })
            .catch(error => {
                alert("Error deleting: " + error.message);
            });
        }
    });

    // --- Delete Room Logic (NEW) ---
    window.openDeleteRoomDialog = function(key) {
        deleteRoomKey = key;
        deleteRoomDialog.classList.add('show');
    }

    btnDeleteRoomConfirm.addEventListener('click', () => {
        if(deleteRoomKey && currentUserId) {
            database.ref('room/' + deleteRoomKey).remove()
            .then(() => {
                showToast("Room Deleted Successfully!");
                deleteRoomDialog.classList.remove('show');
                deleteRoomKey = null;
            })
            .catch(error => {
                alert("Error deleting: " + error.message);
            });
        }
    });

    // --- ROOM LOGIC (NEW) ---

    // 1. Open Room Payment Dialog (Clicking "Payment" in Dropdown)
    window.openRoomPaymentDialog = function(key, name, amount) {
        currentRoomKey = key;
        currentRoomName = name;
        currentRoomAmount = amount;
        currentActionType = 'room_payment';
        workMpinInput.value = '';
        workPinDialogOverlay.classList.add('show');
    }

    // 2. Open Room Advance Dialog (Clicking "Advance" in Dropdown)
    window.openRoomAdvanceDialog = function(key, name) {
        currentRoomKey = key;
        currentRoomName = name;
        advanceAmountInput.value = '';
        currentActionType = 'room_advance_init'; // Special flag to identify generic advance dialog usage
        advanceDialogOverlay.classList.add('show');
    }

    // 3. Open Room View Screen (Clicking Arrow/Card)
    window.openRoomView = function(key, name, mobile, address, amount) {
        document.getElementById('rv-name').textContent = name;
        document.getElementById('rv-mobile').textContent = mobile;
        document.getElementById('rv-address').textContent = address;
        currentRoomViewName = name;
        currentRoomViewMobile = mobile;
        
        roomViewScreen.classList.add('active');
        hideHeader();
        loadRoomHistory(name);
    }

    // 4. Load Room History
    function loadRoomHistory(roomName) {
        const listContainer = document.getElementById('rv-work-list');
        const totalPaymentEl = document.getElementById('rv-total-payment');
        const totalAdvanceEl = document.getElementById('rv-total-advance');
        const subtotalEl = document.getElementById('rv-subtotal');
        
        listContainer.innerHTML = '<p class="text-center text-slate-400 text-sm py-10">Loading history...</p>';
        totalPaymentEl.textContent = '0';
        totalAdvanceEl.textContent = '0';
        subtotalEl.textContent = '0';
        
        const { start, end } = getWeekRange();
        currentRoomWeeklyData = [];

        database.ref('roombill').orderByChild('userid').equalTo(currentUserId).on('value', snapshot => {
            listContainer.innerHTML = '';
            const data = snapshot.val();
            let hasData = false;
            let totalPayment = 0;
            let totalAdvance = 0;

            if (data) {
                Object.keys(data).forEach(key => {
                    const entry = data[key];
                    if (entry.name === roomName) {
                        const date = new Date(entry.date);
                        if (date >= start && date <= end) {
                            hasData = true;
                            currentRoomWeeklyData.push(entry);
                            
                            if (entry.amount) totalPayment += parseFloat(entry.amount) || 0;
                            if (entry.advance) totalAdvance += parseFloat(entry.advance) || 0;
                            
                            const dateStr = date.toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' });
                            const dayStr = date.toLocaleDateString('en-US', { weekday: 'long' });
                            
                            let amountHtml = '';
                            if (entry.amount) {
                                amountHtml = `<div class="text-right"><p class="text-sm font-bold text-green-600 dark:text-green-400">+ ₹${entry.amount}</p><p class="text-[10px] text-slate-400 dark:text-slate-500 uppercase tracking-wide">Payment</p></div>`;
                            } else if (entry.advance) {
                                amountHtml = `<div class="text-right"><p class="text-sm font-bold text-orange-600 dark:text-orange-400">- ₹${entry.advance}</p><p class="text-[10px] text-slate-400 dark:text-slate-500 uppercase tracking-wide">Advance</p></div>`;
                            }
                            
                            listContainer.innerHTML += `
                                <div class="flex justify-between items-center py-3 px-4 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                                    <div>
                                        <p class="text-sm font-medium text-slate-800 dark:text-white">${dateStr}</p>
                                        <p class="text-xs text-slate-400 dark:text-slate-500">${dayStr}</p>
                                    </div>
                                    ${amountHtml}
                                </div>
                            `;
                        }
                    }
                });
            }
            
            totalPaymentEl.textContent = totalPayment;
            totalAdvanceEl.textContent = totalAdvance;
            subtotalEl.textContent = totalPayment - totalAdvance;
            
            if (!hasData) listContainer.innerHTML = '<p class="text-center text-slate-400 text-sm py-10">No history for this week.</p>';
        });
    }

    // 5. Share Room Report
    window.shareRoomReport = function() {
        if (!currentRoomViewMobile) {
            alert("Mobile number not found!");
            return;
        }
        const { start, end } = getWeekRange();
        let message = `*Room Report: ${currentRoomViewName}*\nWeek: ${start.toLocaleDateString()} - ${end.toLocaleDateString()}\n------------------------\n`;
        
        currentRoomWeeklyData.sort((a,b) => new Date(a.date) - new Date(b.date));
        currentRoomWeeklyData.forEach(entry => {
            const d = new Date(entry.date).toLocaleDateString('en-US', { day: 'numeric', month: 'short' });
            if(entry.amount) message += `${d}: Payment (+₹${entry.amount})\n`;
            else if(entry.advance) message += `${d}: Advance (-₹${entry.advance})\n`;
        });
        
        const totP = document.getElementById('rv-total-payment').textContent;
        const totA = document.getElementById('rv-total-advance').textContent;
        const sub = document.getElementById('rv-subtotal').textContent;
        
        message += `------------------------\nTotal Payment: ₹${totP}\nTotal Advance: ₹${totA}\n*Subtotal: ₹${sub}*`;
        
        let phone = currentRoomViewMobile.replace(/\s+/g, '').replace(/-/g, '');
        if (!phone.startsWith('+')) phone = '91' + phone;
        window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank');
    }

    // 6. View All Room History
    window.openRoomViewAll = function() {
        viewAllHistoryScreen.classList.add('active');
        currentHistoryContext = 'room';
        const listContainer = document.getElementById('all-history-list');
        listContainer.innerHTML = '<p class="text-center text-slate-400 text-sm py-10">Loading...</p>';
        document.getElementById('all-history-stats').innerHTML = '';
        
        database.ref('roombill').orderByChild('userid').equalTo(currentUserId).once('value', snapshot => {
            listContainer.innerHTML = '';
            const data = snapshot.val();
            let hasData = false;
            if(data) {
                Object.keys(data).forEach(key => {
                    const entry = data[key];
                    if(entry.name === currentRoomViewName) {
                        hasData = true;
                        const dateStr = new Date(entry.date).toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' });
                        let amountHtml = '';
                        if(entry.amount) amountHtml = `<span class="border border-green-500 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 text-xs font-bold px-2 py-1 rounded">+ ₹${entry.amount}</span>`;
                        else if(entry.advance) amountHtml = `<span class="border border-orange-500 bg-orange-50 dark:bg-orange-900/20 text-orange-700 dark:text-orange-400 text-xs font-bold px-2 py-1 rounded">- ₹${entry.advance}</span>`;
                        
                        const item = document.createElement('div');
                        item.className = 'flex justify-between items-center py-2 px-2 w-full border-b border-slate-100 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 select-none';
                        item.setAttribute('data-key', key);
                        item.innerHTML = `
                            <p class="text-sm font-medium text-slate-800 dark:text-white">${dateStr}</p>
                            ${amountHtml}
                        `;
                        
                        addLongPressListener(item, key);
                        listContainer.appendChild(item);
                    }
                });
            }
            if (!hasData) listContainer.innerHTML = '<p class="text-center text-slate-400 text-sm py-10">No history found.</p>';
        });
    }
    
    // --- History Selection Logic ---
    function addLongPressListener(element, key) {
        element.addEventListener('touchstart', (e) => {
            longPressTimer = setTimeout(() => {
                toggleHistorySelection(key, element);
            }, 600); // 600ms for long press
        });

        element.addEventListener('touchend', () => {
            clearTimeout(longPressTimer);
        });
        
        element.addEventListener('touchmove', () => {
            clearTimeout(longPressTimer);
        });
        
        // Also support mouse for desktop testing
        element.addEventListener('mousedown', () => {
            longPressTimer = setTimeout(() => {
                toggleHistorySelection(key, element);
            }, 600);
        });
        
        element.addEventListener('mouseup', () => {
            clearTimeout(longPressTimer);
        });
        
        // Click to toggle if selection mode is active
        element.addEventListener('click', () => {
            if (selectedHistoryKeys.length > 0) {
                toggleHistorySelection(key, element);
            }
        });
    }
    
    function toggleHistorySelection(key, element) {
        const index = selectedHistoryKeys.indexOf(key);
        if (index > -1) {
            selectedHistoryKeys.splice(index, 1);
            element.classList.remove('history-item-selected');
        } else {
            selectedHistoryKeys.push(key);
            element.classList.add('history-item-selected');
        }
        updateHistorySelectionUI();
    }
    
    function updateHistorySelectionUI() {
        const selectAllBtn = document.getElementById('history-select-all-btn');
        const floatingDialog = document.getElementById('history-floating-dialog');
        
        if (selectedHistoryKeys.length > 0) {
            selectAllBtn.classList.remove('hidden');
            floatingDialog.classList.remove('hidden');
        } else {
            selectAllBtn.classList.add('hidden');
            floatingDialog.classList.add('hidden');
        }
    }
    
    window.selectAllHistory = function() {
        const listItems = document.querySelectorAll('#all-history-list > div');
        selectedHistoryKeys = [];
        listItems.forEach(item => {
            const key = item.getAttribute('data-key');
            if (key) {
                selectedHistoryKeys.push(key);
                item.classList.add('history-item-selected');
            }
        });
        updateHistorySelectionUI();
    }
    
    window.cancelHistorySelection = function() {
        selectedHistoryKeys = [];
        const listItems = document.querySelectorAll('#all-history-list > div');
        listItems.forEach(item => item.classList.remove('history-item-selected'));
        updateHistorySelectionUI();
    }
    
    window.deleteSelectedHistory = function() {
        if (selectedHistoryKeys.length === 0) return;
        
        if (confirm(`Delete ${selectedHistoryKeys.length} items?`)) {
            let dbPath = 'addwork';
            if (currentHistoryContext === 'conductor') dbPath = 'cwork';
            if (currentHistoryContext === 'room') dbPath = 'roombill';
            
            const updates = {};
            selectedHistoryKeys.forEach(key => {
                updates[key] = null;
            });
            
            database.ref(dbPath).update(updates).then(() => {
                showToast("Items Deleted!");
                cancelHistorySelection();
                // Refresh list
                if (currentHistoryContext === 'labour') loadAllWorkHistory(currentLabourViewName);
                else if (currentHistoryContext === 'conductor') openConductorViewAll();
                else if (currentHistoryContext === 'room') openRoomViewAll();
            });
        }
    }
    
    window.editSelectedHistory = function() {
        if (selectedHistoryKeys.length !== 1) {
            alert("Please select exactly one item to edit.");
            return;
        }
        
        // Open simple edit dialog
        document.getElementById('edit-history-amount').value = '';
        document.getElementById('edit-history-dialog').classList.add('show');
    }
    
    document.getElementById('save-edit-history-btn').addEventListener('click', () => {
        const newAmount = document.getElementById('edit-history-amount').value;
        if (!newAmount) {
            alert("Enter amount");
            return;
        }
        
        const key = selectedHistoryKeys[0];
        let dbPath = 'addwork';
        if (currentHistoryContext === 'conductor') dbPath = 'cwork';
        if (currentHistoryContext === 'room') dbPath = 'roombill';
        
        // We need to check if it was amount or advance to update correctly
        database.ref(`${dbPath}/${key}`).once('value').then(snapshot => {
            const data = snapshot.val();
            const updates = {};
            if (data.amount) updates.amount = newAmount;
            else if (data.advance) updates.advance = newAmount;
            else {
                alert("Cannot edit this type of entry.");
                return;
            }
            
            database.ref(`${dbPath}/${key}`).update(updates).then(() => {
                showToast("Updated Successfully!");
                document.getElementById('edit-history-dialog').classList.remove('show');
                cancelHistorySelection();
                // Refresh list
                if (currentHistoryContext === 'labour') loadAllWorkHistory(currentLabourViewName);
                else if (currentHistoryContext === 'conductor') openConductorViewAll();
                else if (currentHistoryContext === 'room') openRoomViewAll();
            });
        });
    });

    // 7. Clear Room Logic
    window.openClearRoomTotalDialog = function() {
        clearRoomTotalDialog.classList.add('show');
    }
    
    btnClearRoomTotalConfirm.addEventListener('click', () => {
         if(!currentRoomViewName) return;
         database.ref('roombill').orderByChild('userid').equalTo(currentUserId).once('value', snapshot => {
            const data = snapshot.val();
            if(data) {
                const updates = {};
                Object.keys(data).forEach(key => {
                    if(data[key].name === currentRoomViewName) updates[key] = null;
                });
                database.ref('roombill').update(updates).then(() => {
                    showToast("Room History Cleared!");
                    clearRoomTotalDialog.classList.remove('show');
                });
            }
        });
    });


    // --- Dialogs & Fab ---
    fab.addEventListener('click', () => {
        const currentActiveTab = document.querySelector('.tab-content.active').id;
        if (currentActiveTab === 'labour-tab') labourDialogOverlay.classList.add('show');
        else if (currentActiveTab === 'conductor-tab') conductorDialogOverlay.classList.add('show');
        else if (currentActiveTab === 'room-tab') roomDialogOverlay.classList.add('show');
        else alert('Go to Labour, Conductor or Room tab to add items.');
    });

    function closeDialog(overlay, form) { overlay.classList.remove('show'); form.reset(); }
    closeLabourDialogBtn.addEventListener('click', () => closeDialog(labourDialogOverlay, addLabourForm));
    closeConductorDialogBtn.addEventListener('click', () => closeDialog(conductorDialogOverlay, addConductorForm));
    closeRoomDialogBtn.addEventListener('click', () => closeDialog(roomDialogOverlay, addRoomForm));

    // --- DB Listeners ---
    function setupListener(path, grid, msg) {
        if (!currentUserId) return;
        database.ref(path).orderByChild('userid').equalTo(currentUserId).on('value', (snapshot) => {
            renderData(snapshot, grid, msg, path); // Pass path/type
        });
    }
    
    function loadLabourData() { setupListener('labour', labourGrid, "No labour data found."); }
    function loadConductorData() { setupListener('conductor', conductorGrid, "No conductor data found."); }
    function loadRoomData() { setupListener('room', roomGrid, "No room data found."); }

    // --- DB Add ---
    function setupAdd(form, path, overlay, dataFn) {
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            if (!currentUserId) return;
            const inputs = form.querySelectorAll('input');
            const data = {
                name: inputs[0].value,
                mobile: inputs[1].value,
                address: inputs[2].value,
                amount: inputs[3].value,
                userid: currentUserId,
                date: new Date().toLocaleDateString()
            };
            database.ref(path).push(data).then(() => closeDialog(overlay, form));
        });
    }
    
    setupAdd(addLabourForm, 'labour', labourDialogOverlay);
    setupAdd(addConductorForm, 'conductor', conductorDialogOverlay);
    setupAdd(addRoomForm, 'room', roomDialogOverlay);
    
    // --- Search Logic Implementation ---
    function filterGrid(inputId, gridId) {
        const input = document.getElementById(inputId);
        const grid = document.getElementById(gridId);
        
        input.addEventListener('input', function() {
            const filter = this.value.toLowerCase();
            const items = grid.children;
            
            Array.from(items).forEach(item => {
                // We need to access the name and mobile from the rendered HTML
                // The structure is: div > div(flex) > h3(name) AND div > div(flex) > span(mobile)
                // A safer way is to add data attributes in renderData, but let's try DOM traversal first
                // or update renderData to include data attributes for easier searching.
                
                // Let's use the data attributes approach for robustness.
                const name = item.getAttribute('data-name') ? item.getAttribute('data-name').toLowerCase() : '';
                const mobile = item.getAttribute('data-mobile') ? item.getAttribute('data-mobile').toLowerCase() : '';
                
                if (name.includes(filter) || mobile.includes(filter)) {
                    item.style.display = "";
                } else {
                    item.style.display = "none";
                }
            });
        });
    }
    
    // Initialize Search Listeners
    filterGrid('labour-search-input', 'labour-grid');
    filterGrid('conductor-search-input', 'conductor-grid');
    filterGrid('room-search-input', 'room-grid');

    // --- Render Function (Modified for Labour Dropdown) ---
    function renderData(snapshot, gridElement, emptyMessage, type = null) {
        const data = snapshot.val();
        gridElement.innerHTML = '';
        if (data) {
            Object.keys(data).forEach(key => {
                const entry = data[key];
                
                // Dropdown HTML for Labour only
                let dropdownHtml = '';
                let onclickAttr = '';
                let arrowBtn = '';
                let deleteIcon = '';
                
                if (type === 'labour') {
                    onclickAttr = `onclick="toggleDropdown('${key}')" class="cursor-pointer bg-white dark:bg-card-dark p-4 rounded-xl shadow border border-slate-200 dark:border-slate-700 transition-all hover:shadow-md relative"`;
                    
                    // Arrow Button
                    arrowBtn = `
                        <button onclick="event.stopPropagation(); openLabourView('${key}', '${entry.name}', '${entry.mobile}', '${entry.address}', '${entry.amount}')" class="absolute top-4 right-4 p-1 text-slate-400 hover:text-primary transition-colors">
                            <span class="material-symbols-outlined">arrow_forward</span>
                        </button>
                    `;
                    
                    // Delete Icon (Right side of date)
                    deleteIcon = `
                        <button onclick="event.stopPropagation(); openDeleteLabourDialog('${key}')" class="text-red-500 hover:text-red-700 transition-colors ml-2">
                            <span class="material-symbols-outlined text-sm">delete</span>
                        </button>
                    `;

                    dropdownHtml = `
                        <div id="dropdown-${key}" class="hidden mt-4 pt-4 border-t border-slate-200 dark:border-slate-700 grid grid-cols-3 gap-2">
                            <!-- Work Box -->
                            <div onclick="event.stopPropagation(); openWorkPinDialog('${key}', '${entry.name}', '${entry.amount}')" class="border border-green-500/30 bg-green-50 dark:bg-green-900/20 rounded-lg p-2 flex flex-col items-center justify-center gap-1 cursor-pointer hover:bg-green-100 dark:hover:bg-green-900/40 transition-colors">
                                <span class="material-symbols-outlined text-green-600">engineering</span>
                                <span class="text-xs font-bold text-green-700 dark:text-green-400">Work</span>
                            </div>
                            <!-- No Work Box -->
                            <div onclick="event.stopPropagation(); openNoWorkPinDialog('${key}', '${entry.name}')" class="border border-red-500/30 bg-red-50 dark:bg-red-900/20 rounded-lg p-2 flex flex-col items-center justify-center gap-1 cursor-pointer hover:bg-red-100 dark:hover:bg-red-900/40 transition-colors">
                                <span class="material-symbols-outlined text-red-600">block</span>
                                <span class="text-xs font-bold text-red-700 dark:text-red-400">No Work</span>
                            </div>
                            <!-- Advance Box -->
                            <div onclick="event.stopPropagation(); openAdvanceDialog('${key}', '${entry.name}')" class="border border-orange-500/30 bg-orange-50 dark:bg-orange-900/20 rounded-lg p-2 flex flex-col items-center justify-center gap-1 cursor-pointer hover:bg-orange-100 dark:hover:bg-orange-900/40 transition-colors">
                                <span class="material-symbols-outlined text-orange-600">payments</span>
                                <span class="text-xs font-bold text-orange-700 dark:text-orange-400">Advance</span>
                            </div>
                        </div>
                    `;
                } else if (type === 'conductor') {
                    onclickAttr = `onclick="toggleDropdown('${key}')" class="cursor-pointer bg-white dark:bg-card-dark p-4 rounded-xl shadow border border-slate-200 dark:border-slate-700 transition-all hover:shadow-md relative"`;
                    
                    // Arrow Button for Conductor
                    arrowBtn = `
                        <button onclick="event.stopPropagation(); openConductorHistory('${key}', '${entry.name}', '${entry.mobile}', '${entry.address}')" class="absolute top-4 right-4 p-1 text-slate-400 hover:text-primary transition-colors">
                            <span class="material-symbols-outlined">arrow_forward</span>
                        </button>
                    `;

                    dropdownHtml = `
                        <div id="dropdown-${key}" class="hidden mt-4 pt-4 border-t border-slate-200 dark:border-slate-700 grid grid-cols-3 gap-2">
                            <!-- Work Box -->
                            <div onclick="event.stopPropagation(); openConductorWorkDialog('${key}', '${entry.name}', '${entry.amount}')" class="border border-green-500/30 bg-green-50 dark:bg-green-900/20 rounded-lg p-2 flex flex-col items-center justify-center gap-1 cursor-pointer hover:bg-green-100 dark:hover:bg-green-900/40 transition-colors">
                                <span class="material-symbols-outlined text-green-600">engineering</span>
                                <span class="text-xs font-bold text-green-700 dark:text-green-400">Work</span>
                            </div>
                            <!-- Delete Box (MODIFIED) -->
                            <div onclick="event.stopPropagation(); openDeleteConductorDialog('${key}')" class="border border-red-500/30 bg-red-50 dark:bg-red-900/20 rounded-lg p-2 flex flex-col items-center justify-center gap-1 cursor-pointer hover:bg-red-100 dark:hover:bg-red-900/40 transition-colors">
                                <span class="material-symbols-outlined text-red-600">delete</span>
                                <span class="text-xs font-bold text-red-700 dark:text-red-400">Delete</span>
                            </div>
                            <!-- Advance Box -->
                            <div class="border border-orange-500/30 bg-orange-50 dark:bg-orange-900/20 rounded-lg p-2 flex flex-col items-center justify-center gap-1 cursor-pointer hover:bg-orange-100 dark:hover:bg-orange-900/40 transition-colors">
                                <span class="material-symbols-outlined text-orange-600">payments</span>
                                <span class="text-xs font-bold text-orange-700 dark:text-orange-400">Advance</span>
                            </div>
                        </div>
                    `;
                } else if (type === 'room') {
                    onclickAttr = `onclick="toggleDropdown('${key}')" class="cursor-pointer bg-white dark:bg-card-dark p-4 rounded-xl shadow border border-slate-200 dark:border-slate-700 transition-all hover:shadow-md relative"`;
                    
                    // Arrow Button for Room
                    arrowBtn = `
                        <button onclick="event.stopPropagation(); openRoomView('${key}', '${entry.name}', '${entry.mobile}', '${entry.address}', '${entry.amount}')" class="absolute top-4 right-4 p-1 text-slate-400 hover:text-primary transition-colors">
                            <span class="material-symbols-outlined">arrow_forward</span>
                        </button>
                    `;
                    
                    dropdownHtml = `
                        <div id="dropdown-${key}" class="hidden mt-4 pt-4 border-t border-slate-200 dark:border-slate-700 grid grid-cols-3 gap-2">
                            <!-- Payment Box -->
                            <div onclick="event.stopPropagation(); openRoomPaymentDialog('${key}', '${entry.name}', '${entry.amount}')" class="border border-green-500/30 bg-green-50 dark:bg-green-900/20 rounded-lg p-2 flex flex-col items-center justify-center gap-1 cursor-pointer hover:bg-green-100 dark:hover:bg-green-900/40 transition-colors">
                                <span class="material-symbols-outlined text-green-600">account_balance_wallet</span>
                                <span class="text-xs font-bold text-green-700 dark:text-green-400">Payment</span>
                            </div>
                            <!-- Delete Box (MODIFIED) -->
                            <div onclick="event.stopPropagation(); openDeleteRoomDialog('${key}')" class="border border-red-500/30 bg-red-50 dark:bg-red-900/20 rounded-lg p-2 flex flex-col items-center justify-center gap-1 cursor-pointer hover:bg-red-100 dark:hover:bg-red-900/40 transition-colors">
                                <span class="material-symbols-outlined text-red-600">delete</span>
                                <span class="text-xs font-bold text-red-700 dark:text-red-400">Delete</span>
                            </div>
                            <!-- Advance Box -->
                            <div onclick="event.stopPropagation(); openRoomAdvanceDialog('${key}', '${entry.name}')" class="border border-orange-500/30 bg-orange-50 dark:bg-orange-900/20 rounded-lg p-2 flex flex-col items-center justify-center gap-1 cursor-pointer hover:bg-orange-100 dark:hover:bg-orange-900/40 transition-colors">
                                <span class="material-symbols-outlined text-orange-600">payments</span>
                                <span class="text-xs font-bold text-orange-700 dark:text-orange-400">Advance</span>
                            </div>
                        </div>
                    `;
                } else {
                    onclickAttr = `class="bg-white dark:bg-card-dark p-4 rounded-xl shadow border border-slate-200 dark:border-slate-700"`;
                }

                // Added data-name and data-mobile attributes for search functionality
                const cardHtml = `
                    <div ${onclickAttr} data-name="${entry.name}" data-mobile="${entry.mobile}">
                        ${arrowBtn}
                        <div class="flex justify-between items-start pr-8">
                            <h3 class="font-bold text-lg text-slate-800 dark:text-white">${entry.name}</h3>
                            <p class="text-sm text-primary font-semibold">₹${entry.amount}</p>
                        </div>
                        <p class="text-slate-500 dark:text-slate-400 text-sm mt-1">${entry.address || 'No address provided'}</p>
                        <div class="flex justify-between items-center mt-3 pt-3 border-t border-slate-200 dark:border-slate-700">
                            <span class="text-xs text-slate-400 dark:text-slate-500 flex items-center gap-1">
                                <span class="material-symbols-outlined text-sm">phone</span>
                                ${entry.mobile}
                            </span>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-slate-400 dark:text-slate-500 flex items-center gap-1">
                                     <span class="material-symbols-outlined text-sm">calendar_today</span>
                                    ${entry.date}
                                </span>
                                ${deleteIcon}
                            </div>
                        </div>
                        ${dropdownHtml}
                    </div>`;
                gridElement.innerHTML += cardHtml;
            });
        } else {
            gridElement.innerHTML = `<p class="col-span-full text-center text-slate-500 dark:text-slate-400">${emptyMessage} Add one using the "+" button.</p>`;
        }
    }

</script>
</body>
</html>